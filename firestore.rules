/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes strong authorization based on user identity and data ownership.
 * It uses a combination of path-based ownership, denormalized roles, and explicit membership lists
 * to control access to data. Data shape is not strictly enforced to allow rapid iteration, but
 * authorization-critical fields are validated.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.  `userId` MUST match the authenticated user's UID.
 * - /listings/{listingId}: Stores listings. `sellerId` field is used for ownership checks.
 * - /chats/{chatId}: Stores chat metadata, including a `participants` array for authorization.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat. Access controlled by `chatId`.
 * - /reviews/{reviewId}: Stores reviews, linked to sellers and buyers via `sellerId` and `buyerId`.
 * - /events/{eventId}: Stores event information.  `organizerId` field is used for ownership checks.
 * - /community_feed/{postId}: Stores community feed posts.  `authorId` field is used for ownership checks.
 * - /reports/{reportId}: Stores reports about users or content. Access is not restricted.
 * - /transactions/{transactionId}: Stores transaction data, with `buyerId`, `sellerId`, and `listingId` for relationships.
 * - /roles_admin/{userId}:  Existence of a document at this path grants admin privileges to the user.
 *
 * Key Security Decisions:
 * - User listing is disabled for privacy.
 * - Shared access (chats) uses explicit `participants` arrays on the chat document.
 * - Admin roles are determined by the existence of a document in the `/roles_admin` collection.
 * - Data validation is limited to authorization-critical fields (e.g., ownership).
 *
 * Denormalization for Authorization:
 * - Listings include `sellerId` to allow ownership checks without additional reads.
 * - Chats include a `participants` array to determine authorized users.
 *
 * Structural Segregation:
 * - User data and administrative role data are stored in separate collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) User with uid 'user123' creates their profile with matching uid.
     * @allow (get, update, delete) Authenticated user with uid 'user123' reads/writes their own profile.
     * @deny (create, get, update, delete) Authenticated user with uid 'user456' attempts to read/write profile 'user123'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isSignedIn() && request.auth.uid == userId && resource.data.keys().size() > 0;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is disabled for privacy.
      allow create: if isOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to listings. Only the seller can modify their listing.  Anyone can read.
     * @path /listings/{listingId}
     * @allow (get, list) Any user can read or list listings.
     * @allow (create) Authenticated user with uid 'user123' creates a listing with sellerId 'user123'.
     * @allow (update, delete) Authenticated user with uid 'user123' updates/deletes a listing where resource.data.sellerId == 'user123'.
     * @deny (create) Authenticated user with uid 'user456' creates a listing with sellerId 'user123'.
     * @deny (update, delete) Authenticated user with uid 'user456' attempts to update/delete a listing where resource.data.sellerId == 'user123'.
     * @principle Enforces document ownership for listings, allows public reads.
     */
    match /listings/{listingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(sellerId) {
        return isSignedIn() && request.auth.uid == sellerId;
      }

      function isExistingOwner(sellerId) {
        return isSignedIn() && request.auth.uid == sellerId && resource.data.keys().size() > 0;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data.sellerId);
      allow delete: if isSignedIn() && isOwner(resource.data.sellerId);
    }

    /**
     * @description Controls access to chats. Only participants can read/write chat metadata.
     * @path /chats/{chatId}
     * @allow (create) Authenticated user creates a chat if they are in the participants list.
     * @allow (get, list, update, delete) Authenticated user can get, list, update, or delete a chat if they are in the participants list.
     * @deny (create, get, list, update, delete) Authenticated user attempts to access a chat they are not a participant of.
     * @principle Enforces shared access based on the `participants` array in the chat document.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && request.resource.data.participants is list && request.resource.data.participants.hasAny([request.auth.uid]);
      }

      function isExistingParticipant() {
          return isSignedIn() && resource.data.participants is list && resource.data.participants.hasAny([request.auth.uid]);
      }

      allow get, list: if isExistingParticipant();
      allow create: if isSignedIn() && request.resource.data.participants is list && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isExistingParticipant();
      allow delete: if isExistingParticipant();
    }

    /**
     * @description Controls access to messages within a chat. Only participants can read/write messages.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) Authenticated user creates a message if they are a participant in the parent chat.
     * @allow (get, list) Authenticated user reads a message if they are a participant in the parent chat.
     * @allow (update, delete) No one can update or delete a message.
     * @deny (create, get, list) Authenticated user attempts to access messages in a chat they are not a participant of.
     * @principle Enforces shared access to chat messages based on the parent chat's `participants` array.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants is list && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      allow get, list: if isChatParticipant(chatId);
      allow create: if isChatParticipant(chatId);
      allow update, delete: if false;
    }

    /**
     * @description Controls access to reviews.
     * @path /reviews/{reviewId}
     * @allow (get, list) Any authenticated user can list and get the reviews.
     * @allow (create) Any authenticated user can create a review.
     * @deny (update, delete) Reviews cannot be updated or deleted once created.
     */
    match /reviews/{reviewId} {
       function isSignedIn() {
        return request.auth != null;
      }
       allow get, list: if isSignedIn();
       allow create: if isSignedIn();
       allow update, delete: if false;
    }

    /**
     * @description Controls access to events. Only the organizer can modify their event.  Anyone can read.
     * @path /events/{eventId}
     * @allow (get, list) Any user can read or list events.
     * @allow (create) Authenticated user with uid 'user123' creates a event with organizerId 'user123'.
     * @allow (update, delete) Authenticated user with uid 'user123' updates/deletes a event where resource.data.organizerId == 'user123'.
     * @deny (create) Authenticated user with uid 'user456' creates a event with organizerId 'user123'.
     * @deny (update, delete) Authenticated user with uid 'user456' attempts to update/delete a event where resource.data.organizerId == 'user123'.
     * @principle Enforces document ownership for events, allows public reads.
     */
    match /events/{eventId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(organizerId) {
        return isSignedIn() && request.auth.uid == organizerId;
      }

      function isExistingOwner(organizerId) {
        return isSignedIn() && request.auth.uid == organizerId && resource.data.keys().size() > 0;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data.organizerId);
      allow delete: if isSignedIn() && isOwner(resource.data.organizerId);
    }

    /**
     * @description Controls access to community feed posts. Only the author can modify their post.  Anyone can read.
     * @path /community_feed/{postId}
     * @allow (get, list) Any user can read or list posts.
     * @allow (create) Authenticated user with uid 'user123' creates a post with authorId 'user123'.
     * @allow (update, delete) Authenticated user with uid 'user123' updates/deletes a post where resource.data.authorId == 'user123'.
     * @deny (create) Authenticated user with uid 'user456' creates a post with authorId 'user123'.
     * @deny (update, delete) Authenticated user with uid 'user456' attempts to update/delete a post where resource.data.authorId == 'user123'.
     * @principle Enforces document ownership for community feed posts, allows public reads.
     */
    match /community_feed/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(authorId) {
        return isSignedIn() && request.auth.uid == authorId;
      }

      function isExistingOwner(authorId) {
        return isSignedIn() && request.auth.uid == authorId && resource.data.keys().size() > 0;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data.authorId);
      allow delete: if isSignedIn() && isOwner(resource.data.authorId);
    }

    /**
     * @description Controls access to reports.
     * @path /reports/{reportId}
     * @allow (get, list) Any authenticated user can list and get the reports.
     * @allow (create) Any authenticated user can create a report.
     * @deny (update, delete) Reports cannot be updated or deleted once created.
     */
    match /reports/{reportId} {
       function isSignedIn() {
        return request.auth != null;
      }
       allow get, list: if isSignedIn();
       allow create: if isSignedIn();
       allow update, delete: if false;
    }

    /**
     * @description Controls access to transactions.
     * @path /transactions/{transactionId}
     * @allow (get, list) Any authenticated user can list and get the transactions.
     * @allow (create) Any authenticated user can create a transaction.
     * @deny (update, delete) Transactions cannot be updated or deleted once created.
     */
    match /transactions/{transactionId} {
       function isSignedIn() {
        return request.auth != null;
      }
       allow get, list: if isSignedIn();
       allow create: if isSignedIn();
       allow update, delete: if false;
    }

    /**
     * @description Controls access to admin roles. Only a user with a document in this collection is an admin.
     * @path /roles_admin/{userId}
     * @allow (get) Any request will reach the backend.
     * @allow (list) Listing is disabled.
     * @allow (create) Only the user themselves can create the document, effectively granting themselves admin.
     * @allow (update, delete) No one can update or delete. Admin role is self-granted on create and permanent.
     * @principle Enforces admin roles via document existence in a dedicated collection.
     */
    match /roles_admin/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }
  }
}