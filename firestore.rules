/**
 * @fileoverview Firestore Security Rules for Nexus Student Marketplace.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and associated data
 * while allowing public read access to listings.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`, accessible only to the owning user.
 * - Listings are stored under `/listings/{listingId}` and include the sellerId for
 *   ownership checks.  Listings are publicly readable, but only the owner can modify them.
 * - Transactions, Reviews, and ChatMessages are stored in their respective top-level collections.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Listings are publicly readable but only the seller can modify. The `sellerId`
 *   field in the `Listing` document is critical for enforcing this.
 * - Transactions, Reviews, and ChatMessages are protected with owner-based access control.
 *
 * Denormalization for Authorization:
 * - The `Listing` entity includes the `sellerId` to enable direct ownership checks
 *   without additional reads. This improves performance and simplifies rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get, list, create, update, delete) User with ID 'user_abc' can read/write their own profile.
     * @deny (get, list, create, update, delete) User with ID 'user_xyz' cannot read/write profile of 'user_abc'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId);
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to listing documents.
     * @path /listings/{listingId}
     * @allow (get, list) Any user can read all listings.
     * @allow (create) User with ID 'user_abc' can create a listing with sellerId 'user_abc'.
     * @allow (update, delete) User with ID 'user_abc' can update/delete a listing where listing.sellerId == 'user_abc'.
     * @deny (create) User with ID 'user_xyz' cannot create a listing with sellerId 'user_abc'.
     * @deny (update, delete) User with ID 'user_xyz' cannot update/delete a listing where listing.sellerId == 'user_abc'.
     * @principle Allows public read access but restricts writes to the owner (seller).
     */
    match /listings/{listingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(sellerId) {
        return request.auth.uid == sellerId;
      }

      function isExistingOwner(sellerId) {
        return isOwner(sellerId);
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner(resource.data.sellerId);
      allow delete: if isSignedIn() && isOwner(resource.data.sellerId);
    }

    /**
     * @description Controls access to transaction documents.
     * @path /transactions/{transactionId}
     * @allow (get, list, create, update, delete) Signed-in user can read/write transaction documents.
     * @deny (get, list, create, update, delete) Request without authentication will be denied.
     */
    match /transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to review documents.
     * @path /reviews/{reviewId}
     * @allow (get, list, create, update, delete) Signed-in user can read/write review documents.
     * @deny (get, list, create, update, delete) Request without authentication will be denied.
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to chat message documents.
     * @path /messages/{messageId}
     * @allow (get, list, create, update, delete) Signed-in user can read/write chat message documents.
     * @deny (get, list, create, update, delete) Request without authentication will be denied.
     */
    match /messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}