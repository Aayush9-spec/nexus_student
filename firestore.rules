rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with matching UID creates their profile.
     * @allow (get, update, delete) - Authenticated user reads, updates, or deletes their own profile.
     * @deny (create, update, delete) - Any other user attempts to create, update, or delete another user's profile.
     * @deny (list) - Listing all users is disallowed to protect user privacy.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is the owner of the document
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Allow the user to read their own profile
      allow get: if isSignedIn() && isOwner(userId);

      // Prevent listing all users
      allow list: if false;

      // Allow a user to create their own profile, with UID in the document matching the path
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.uid == request.auth.uid;

      // Allow a user to update their own profile
      allow update: if isSignedIn() && isOwner(userId);

      // Allow a user to delete their own profile
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages listings (products or services).
     * @path /listings/{listingId}
     * @allow (get, list) - Anyone can view listings.
     * @allow (create) - Authenticated user creates a listing with their UID as the sellerId.
     * @allow (update, delete) - Only the seller can update or delete their listings.
     * @deny (create, update, delete) - Other users cannot create, update, or delete listings on behalf of someone else.
     * @principle Allows public reads with owner-only writes, validates sellerId on create.
     */
    match /listings/{listingId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is the seller of the listing
      function isSeller(sellerId) {
        return request.auth.uid == sellerId;
      }

      // Allow anyone to read or list listings
      allow get, list: if true;

      // Allow an authenticated user to create a listing, ensuring sellerId matches their UID
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;

      // Allow the seller to update the listing
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;

      // Allow the seller to delete the listing
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Manages chat conversations between users.
     * @path /chats/{chatId}
     * @allow (get, list) - Only participants can view chat metadata.
     * @allow (create) - Authenticated user creates a chat if they are a participant.
     * @allow (update, delete) - Only participants can update or delete a chat.
     * @deny - Non-participants cannot access chat metadata or create, update, or delete chats.
     * @principle Enforces shared access based on the 'participants' array.
     */
    match /chats/{chatId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is a participant in the chat
      function isParticipant() {
        return request.auth.uid in request.resource.data.participants;
      }

      // Allow a participant to read or list chats
      allow get, list: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);

      // Allow a participant to create a chat if their UID is in the participants array
      allow create: if isSignedIn() && request.resource.data.participants.hasAll([request.auth.uid]);

      // Allow a participant to update the chat
      allow update: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);

      // Allow a participant to delete the chat
      allow delete: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Manages messages within a chat conversation.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) - Only participants in the parent chat can view messages.
     * @allow (create) - Only participants in the parent chat can create messages.
     * @allow (update, delete) - Only the message sender can update or delete the message.
     * @deny - Non-participants cannot access, create, update, or delete messages.
     * @principle Enforces shared access to chat messages based on parent chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is a participant in the chat
      function isChatParticipant() {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      // Allow a participant in the chat to read or list messages
      allow get, list: if isSignedIn() && isChatParticipant();

      // Allow a participant in the chat to create messages
      allow create: if isSignedIn() && isChatParticipant();

      // Allow the sender to update the message
      allow update: if isSignedIn() && resource.data.senderId == request.auth.uid;

      // Allow the sender to delete the message
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }

    /**
     * @description Manages reviews of sellers by buyers.
     * @path /reviews/{reviewId}
     * @allow (get, list) - Anyone can view reviews.
     * @allow (create) - Authenticated user creates a review, with the correct buyerId.
     * @allow (update, delete) - Only the buyer can update or delete their review.
     * @deny - Other users cannot create, update, or delete reviews on behalf of someone else.
     * @principle Allows public reads with owner-only writes for buyer.
     */
    match /reviews/{reviewId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is the buyer of the review
      function isBuyer(buyerId) {
        return request.auth.uid == buyerId;
      }

      // Allow anyone to read or list reviews
      allow get, list: if true;

      // Allow an authenticated user to create a review, ensuring buyerId matches their UID
      allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;

      // Allow the buyer to update the review
      allow update: if isSignedIn() && resource.data.buyerId == request.auth.uid;

      // Allow the buyer to delete the review
      allow delete: if isSignedIn() && resource.data.buyerId == request.auth.uid;
    }

    /**
     * @description Manages event information.
     * @path /events/{eventId}
     * @allow (get, list) - Anyone can view event information.
     * @allow (create) - Authenticated user creates an event with their UID as the organizerId.
     * @allow (update, delete) - Only the organizer can update or delete events.
     * @deny - Other users cannot create, update, or delete events on behalf of someone else.
     * @principle Allows public reads with owner-only writes, validates organizerId on create.
     */
    match /events/{eventId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is the organizer of the event
      function isOrganizer(organizerId) {
        return request.auth.uid == organizerId;
      }

      // Allow anyone to read or list events
      allow get, list: if true;

      // Allow an authenticated user to create an event, ensuring organizerId matches their UID
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;

      // Allow the organizer to update the event
      allow update: if isSignedIn() && resource.data.organizerId == request.auth.uid;

      // Allow the organizer to delete the event
      allow delete: if isSignedIn() && resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Manages community feed posts.
     * @path /community_feed/{postId}
     * @allow (get, list) - Anyone can view community feed posts.
     * @allow (create) - Authenticated user creates a post with their UID as the authorId.
     * @allow (update, delete) - Only the author can update or delete their posts.
     * @deny - Other users cannot create, update, or delete posts on behalf of someone else.
     * @principle Allows public reads with owner-only writes, validates authorId on create.
     */
    match /community_feed/{postId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is the author of the post
      function isAuthor(authorId) {
        return request.auth.uid == authorId;
      }

      // Allow anyone to read or list community feed posts
      allow get, list: if true;

      // Allow an authenticated user to create a post, ensuring authorId matches their UID
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;

      // Allow the author to update the post
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;

      // Allow the author to delete the post
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Manages reports of users or content.
     * @path /reports/{reportId}
     * @allow read: false;
     * @allow list: false;
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Only authenticated users can create Reports, no one can read, update or delete them.
     */
    match /reports/{reportId} {
      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Disallow reading reports
      allow get, list: if false;

      // Allow an authenticated user to create a report
      allow create: if isSignedIn();

      // Disallow updating reports
      allow update: if false;

      // Disallow deleting reports
      allow delete: if false;
    }

    /**
     * @description Manages transactions between buyers and sellers.
     * @path /transactions/{transactionId}
     * @allow read: false;
     * @allow list: false;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     */
    match /transactions/{transactionId} {
         // Utility function to check if the user is signed in
         function isSignedIn() {
           return request.auth != null;
         }

         // Disallow reading reports
         allow get, list: if false;

         // Allow an authenticated user to create a report
         allow create: if false;

         // Disallow updating reports
         allow update: if false;

         // Disallow deleting reports
         allow delete: if false;
     }


    /**
     * @description Manages admin roles using document existence.
     * @path /roles_admin/{userId}
     * @allow get: if isAdmin();
     * @allow list: if false;
     * @allow create: if isAdmin();
     * @allow update: if false;
     * @allow delete: if isAdmin();
     * @principle Grants admin privileges based on document existence in this collection.
     */
    match /roles_admin/{userId} {

      // Utility function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Utility function to check if the user is an admin
      function isAdmin() {
          return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      // Only admins can read, create, and delete
      allow get: if isSignedIn() && isAdmin();
      allow list: if false; // No listing this collection
      allow create: if isSignedIn() && isAdmin();
      allow update: if false;
      allow delete: if isSignedIn() && isAdmin();
    }
  }
}