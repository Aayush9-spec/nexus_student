/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for user profiles and their associated data,
 * and a collaborative access model for chats. Public read access is granted to community feed posts,
 * but write access is restricted to the author. The rules are designed to prevent unauthorized data
 * access and modification, ensuring that only authorized users can read or write data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owning user.
 * - /listings/{listingId}: Stores listings, where ownership is determined by the sellerId field.
 * - /chats/{chatId}: Stores chat conversations, with access controlled by the participants list.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat, accessible to chat participants.
 * - /reviews/{reviewId}: Stores reviews for sellers; write access is restricted to the buyer and seller.
 * - /events/{eventId}: Stores event information, accessible to the organizer.
 * - /community_feed/{postId}: Stores community feed posts, publicly readable but writable only by the author.
 * - /reports/{reportId}: Stores reports of users or content.
 * - /transactions/{transactionId}: Stores transaction information.
 * - /roles_admin/{userId}: Stores admin roles; the existence of a document grants admin privileges.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Data validation is relaxed to allow for rapid prototyping.
 * - Global admin roles are managed via existence checks in a dedicated collection.
 * - Public read access is granted to the CommunityFeed collection, with owner-only writes.
 *
 * Denormalization for Authorization:
 * - Listings include the sellerId to allow rules to validate ownership without get() calls.
 * - Chats include a participants array to explicitly define authorized users.
 *
 * Structural Segregation:
 * - User data is stored under /users/{userId} for clear ownership.
 * - Admin role data is stored separately in /roles_admin/{userId}.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants owner-only access to user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with UID matching the userId can create their profile.
     * @allow (get, list, update, delete) - Authenticated user with UID matching the userId can read, update, or delete their profile.
     * @deny (create) - Authenticated user attempts to create a profile with a userId that doesn't match their UID.
     * @deny (update, delete) - Unauthenticated user attempts to update or delete a user profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Grants public read access to listings, but restricts write access to the seller.
     * @path /listings/{listingId}
     * @allow (get, list) - Any user can read any listing.
     * @allow (create) - Authenticated user can create a listing with a matching sellerId.
     * @allow (update, delete) - The seller (owner) of the listing can update or delete it.
     * @deny (create) - Authenticated user attempts to create a listing with a sellerId that doesn't match their UID.
     * @deny (update, delete) - Unauthenticated user attempts to update or delete a listing.
     * @principle Grants public read access with owner-only writes; enforces ownership for writes.
     */
    match /listings/{listingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.sellerId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.sellerId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.sellerId;
    }

    /**
     * @description Grants access to chat documents to participants only.
     * @path /chats/{chatId}
     * @allow (get, list) - A participant can read the chat document.
     * @allow (create) - Any authenticated user can create a chat.
     * @allow (update, delete) - Only participants can update the chat.
     * @deny (get, list) - A non-participant attempts to read the chat document.
     * @deny (update, delete) - A non-participant attempts to update or delete the chat document.
     * @principle Enforces shared access (closed collaboration) based on the participants list.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }


      allow get, list: if isSignedIn() && isParticipant();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isParticipant();
      allow delete: if false;
    }

    /**
     * @description Grants access to messages within a chat to participants only.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) - A participant can read the messages in the chat.
     * @allow (create) - Any participant can create a message in the chat.
     * @allow (update, delete) - No one can update or delete a message.
     * @deny (get, list) - A non-participant attempts to read the messages in the chat.
     * @deny (create) - A non-participant attempts to create a message in the chat.
     * @principle Enforces shared access (closed collaboration) based on the parent chat's participants list.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }

      allow get, list: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update, delete: if false;
    }

    /**
     * @description Grants access to reviews, allowing the buyer and seller to perform certain actions.
     * @path /reviews/{reviewId}
     * @allow (get, list) - Any user can read any review.
     * @allow (create) - Authenticated user can create a review.
     * @allow (update, delete) - No one can update or delete a review.
     * @deny (create) - Unauthenticated user attempts to create a review.
     * @principle Allows any user to read any review, authenticated user to create review.
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Grants access to event documents, allowing the organizer to perform certain actions.
     * @path /events/{eventId}
     * @allow (get, list) - Any user can read any event document.
     * @allow (create) - Authenticated user can create a new event document.
     * @allow (update, delete) - Only the organizer can update or delete the event document.
     * @deny (create) - Unauthenticated user attempts to create a new event document.
     * @deny (update, delete) - Non-organizer attempts to update or delete the event document.
     * @principle Allows any user to read event document, but only the organizer can create, update, or delete.
     */
    match /events/{eventId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.organizerId;
      }



      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.organizerId;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Grants public read access to community feed posts, but restricts write access to the author.
     * @path /community_feed/{postId}
     * @allow (get, list) - Any user can read any community feed post.
     * @allow (create) - Authenticated user can create a new community feed post.
     * @allow (update, delete) - Only the author can update or delete the community feed post.
     * @deny (create) - Unauthenticated user attempts to create a new community feed post.
     * @deny (update, delete) - Non-author attempts to update or delete the community feed post.
     * @principle Grants public read access with owner-only writes; enforces ownership for writes.
     */
    match /community_feed/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }



      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.authorId;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

   /**
     * @description Grants access to reports; currently, no specific access control is implemented.
     * @path /reports/{reportId}
     * @allow (get, list) - Any user can read any report.
     * @allow (create) - Any authenticated user can create a new report.
     * @allow (update, delete) - No one can update or delete a report.
     * @principle Allows any user to read any report, and authenticated user to create report.
     */
    match /reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Grants access to transactions; currently, no specific access control is implemented.
     * @path /transactions/{transactionId}
     * @allow (get, list) - Any user can read any transaction.
     * @allow (create) - Any authenticated user can create a new transaction.
     * @allow (update, delete) - No one can update or delete a transaction.
     * @principle Allows any user to read any transaction, and authenticated user to create transaction.
     */
    match /transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow (get) - Any user can check if a user has admin privileges.
     * @allow (list) - Listing all admin roles is denied.
     * @allow (create) - Only an existing admin can assign a new admin role.
     * @allow (update, delete) - Only an existing admin can update or delete an admin role assignment.
     * @deny (create, update, delete) - Non-admin attempts to modify admin roles.
     * @principle Manages global admin roles via existence checks; restricts modification to existing admins.
     */
    match /roles_admin/{userId} {
        function isAdmin() {
          return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

        allow get: if true;
        allow list: if false;
        allow create: if isSignedIn() && isAdmin();
        allow update: if isSignedIn() && isAdmin();
        allow delete: if isSignedIn() && isAdmin();
    }
  }
}