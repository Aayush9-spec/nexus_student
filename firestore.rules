/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and a collaborative access model for chats.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Access is restricted to the user themselves.
 * - /listings/{listingId}: Stores listings. The seller owns the listing and can modify it.
 * - /chats/{chatId}: Stores chat metadata. Access is granted to participants listed in the 'participants' array.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat. Only participants of the chat can read/write messages.
 * - /reviews/{reviewId}: Stores reviews for sellers.
 * - /events/{eventId}: Stores event information. The organizer owns the event and can modify it.
 * - /community_feed/{postId}: Stores community feed posts.
 * - /reports/{reportId}: Stores reports of users or content.
 * - /transactions/{transactionId}: Stores transaction information.
 * - /roles_admin/{userId}: Stores admin roles.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user profile data.
 * - Listings can be created, updated, and deleted by the seller only.
 * - Chat access is based on the participants array.
 * - List operations are generally allowed for owner-specific subcollections.
 * - Global admin roles are managed via existence checks in the `/roles_admin` collection.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to allow rules to validate ownership without `get()` calls.
 * - Chats utilize a `participants` array within each document to explicitly define authorized users.
 *
 * Structural Segregation:
 * - User data and administrative data are segregated into different collections for enhanced security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own profile data.
     * @path /users/{userId}
     * @allow (create) User with uid 'user_abc' can create their profile.
     * @deny (create) User with uid 'user_xyz' cannot create a profile for 'user_abc'.
     * @allow (get, update, delete) User with uid 'user_abc' can read and modify their profile.
     * @deny (get, update, delete) User with uid 'user_xyz' cannot read or modify the profile of 'user_abc'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Allows sellers to manage their listings.
     * @path /listings/{listingId}
     * @allow (create) User with uid 'user_abc' can create a listing with sellerId 'user_abc'.
     * @deny (create) User with uid 'user_xyz' cannot create a listing with sellerId 'user_abc'.
     * @allow (get, list) Any user can read the listing data.
     * @allow (update, delete) User with uid 'user_abc' can update/delete their listing (where sellerId is 'user_abc').
     * @deny (update, delete) User with uid 'user_xyz' cannot update/delete a listing where sellerId is 'user_abc'.
     * @principle Enforces document ownership for writes and allows public reads.
     */
    match /listings/{listingId} {
        function isOwner() {
            return request.auth.uid == resource.data.sellerId;
        }
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
        allow update: if isSignedIn() && isOwner();
        allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows participants of a chat to manage chat messages.
     * @path /chats/{chatId}
     * @allow (create) Any authenticated user can create a chat. Participants will be added later by update.
     * @deny (create) If user not authenticated.
     * @allow (get, list) Participants of the chat can read the chat data.
     * @allow (update) Only participants of a chat can modify the chat.
     * @deny (update) Non-participants cannot modify the chat.
     * @allow (delete) If false for now.
     * @principle Enforces collaborative access based on the 'participants' array.
     */
    match /chats/{chatId} {
      function isParticipant() {
          return request.auth.uid in resource.data.participants;
      }
      function isParticipantCreate() {
          return request.auth.uid in request.resource.data.participants;
      }
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if isSignedIn() && isParticipant();
      allow create: if isSignedIn() && request.resource.data.participants is list && isParticipantCreate();
      allow update: if isSignedIn() && isParticipant();
      allow delete: if false;
    }

    /**
     * @description Allows participants to manage messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) Participants of the chat can create messages.
     * @deny (create) Non-participants cannot create messages.
     * @allow (get, list) Participants of the chat can read messages.
     * @deny (get, list) Non-participants cannot read messages.
     * @allow (update, delete) If false for now.
     * @principle Enforces collaborative access to messages based on chat participants.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isParticipant(chatId) {
        return request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if isSignedIn() && isParticipant(chatId);
      allow create: if isSignedIn() && isParticipant(chatId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read reviews, but restricts creation.
     * @path /reviews/{reviewId}
     * @allow (get, list) Any user can read reviews.
     * @allow (create) Any authenticated user can create a review.
     * @deny (update, delete) No one can update or delete reviews.
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows organizers to manage events, and anyone to read events.
     * @path /events/{eventId}
     * @allow (get, list) Any user can read event data.
     * @allow (create) Authenticated user can create event.
     * @allow (update, delete) Only the organizer can update/delete the event.
     * @principle Enforces document ownership for event writes and allows public reads.
     */
    match /events/{eventId} {
        function isOwner() {
            return request.auth.uid == resource.data.organizerId;
        }
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
        allow update: if isSignedIn() && isOwner();
        allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows anyone to read community feed posts, but restricts creation to authenticated users.
     * @path /community_feed/{postId}
     * @allow (get, list) Any user can read community feed posts.
     * @allow (create) Any authenticated user can create a post.
     * @allow (update, delete) Only the author can update/delete the post.
     * @principle Enforces document ownership for writes and allows public reads.
     */
    match /community_feed/{postId} {
        function isOwner() {
            return request.auth.uid == resource.data.authorId;
        }
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && isOwner();
        allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Allows creation of reports, but restricts reading, updating, and deletion.
     * @path /reports/{reportId}
     * @allow (create) Any authenticated user can create a report.
     * @deny (get, list, update, delete) No one can read, update, or delete reports.
     */
    match /reports/{reportId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow create: if isSignedIn();
      allow get, list: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows creation of transactions.
     * @path /transactions/{transactionId}
     * @allow (create) Any authenticated user can create a transaction.
     * NOTE: This is unsafe and should be secured in a production environment.
     * TODO: Implement proper authorization for transaction creation, updates, and deletion.
     */
    match /transactions/{transactionId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow create: if isSignedIn();
      allow get, list: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows admins to manage user roles. Admin privileges are verified by document existence.
     * @path /roles_admin/{userId}
     * @allow (create) If user is admin.
     * @allow (get, list) If user is admin.
     * @allow (update) If user is admin.
     * @allow (delete) If user is admin.
     * @principle Enforces admin-only access based on document existence in the /roles_admin collection.
     */
    match /roles_admin/{userId} {
      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list, create, update, delete: if isSignedIn() && isAdmin();
    }
  }
}