/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-centric model, with strong emphasis on
 * explicit authorization and relational integrity. It leverages denormalization
 * to avoid costly `get()` calls and enables simpler, more performant rules.
 *
 * Data Structure:
 * - Users: Stored in `/users/{userId}`, with ownership enforced via path-based
 *   validation.
 * - Listings: Stored in `/listings/{listingId}`, with `sellerId` for owner-based access.
 * - Chats: Stored in `/chats/{chatId}`, with a `participants` array for authorized access.
 * - Messages: Stored in `/chats/{chatId}/messages/{messageId}`, inheriting chat access control.
 * - Reviews: Stored in `/reviews/{reviewId}`, with `sellerId` and `buyerId` for access control.
 * - Events: Stored in `/events/{eventId}`, with `organizerId` for owner-based access.
 * - Community Feed: Stored in `/community_feed/{postId}`, with `authorId` for owner-based access.
 * - Reports: Stored in `/reports/{reportId}`.
 * - Transactions: Stored in `/transactions/{transactionId}`, with `buyerId` and `sellerId`.
 * - Admin Roles: Stored in `/roles_admin/{userId}`. Existence implies admin rights.
 *
 * Key Security Decisions:
 * - User listing is allowed for authenticated users.
 * - Public read access is granted to listings and community feed posts.
 * - Admin privileges are determined by the presence of a document in the
 *   `/roles_admin/{userId}` collection.
 * - All write operations are strictly validated against ownership or authorized
 *   membership.
 *
 * Denormalization for Authorization:
 * - Listings include `sellerId` to enable owner-based rules without extra reads.
 * - Chats include a `participants` array for direct membership checks.
 *
 * Structural Segregation:
 * - Admin roles are stored in a separate `/roles_admin` collection, enabling
 *   efficient existence-based checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's ID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Determines if the user is a participant in the chat.
     * @param {array} participants The array of user IDs participating in the chat.
     * @return {bool} True if the user is a participant, false otherwise.
     */
    function isChatParticipant(participants) {
      return isSignedIn() && participants.hasAny([request.auth.uid]);
    }


    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their profile.
     *   - auth.uid: 'user123'
     *   - request.resource.data.uid: 'user123'
     * @deny (create) User with ID 'user123' tries to create profile for 'otherUser'.
     *   - auth.uid: 'user123'
     *   - request.resource.data.uid: 'otherUser'
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for listings.
     * @path /listings/{listingId}
     * @allow (create) User creates a listing with their ID as the sellerId.
     *   - auth.uid: 'user123'
     *   - request.resource.data.sellerId: 'user123'
     * @deny (update) User tries to update a listing they don't own.
     *   - auth.uid: 'user456'
     *   - resource.data.sellerId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid && resource != null;
    }

    /**
     * @description Rules for chats.
     * @path /chats/{chatId}
     * @allow (create) User who is a participant creates a chat.
     *   - auth.uid: 'user123'
     *   - request.resource.data.participants: ['user123', 'user456']
     * @deny (read) User who is not a participant tries to read a chat.
     *   - auth.uid: 'user789'
     *   - resource.data.participants: ['user123', 'user456']
     * @principle Enforces authorized membership for access.
     */
    match /chats/{chatId} {
      allow get, list: if isChatParticipant(resource.data.participants);
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && isChatParticipant(resource.data.participants) && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rules for messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) User who is a participant in the parent chat creates a message.
     *   - auth.uid: 'user123'
     *   - get(/databases/$(database)/documents/chats/chat123).data.participants: ['user123', 'user456']
     * @deny (read) User who is not a participant in the parent chat tries to read a message.
     *   - auth.uid: 'user789'
     *   - get(/databases/$(database)/documents/chats/chat123).data.participants: ['user123', 'user456']
     * @principle Enforces authorized membership inherited from the parent chat.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) && request.resource.data.senderId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for reviews.
     * @path /reviews/{reviewId}
     * @allow (create) User creates a review with their ID as the buyerId.
     *   - auth.uid: 'user123'
     *   - request.resource.data.buyerId: 'user123'
     * @deny (update) User tries to update a review they didn't create.
     *   - auth.uid: 'user456'
     *   - resource.data.buyerId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /reviews/{reviewId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.buyerId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.buyerId == request.auth.uid && resource != null;
    }

    /**
     * @description Rules for events.
     * @path /events/{eventId}
     * @allow (create) User creates an event with their ID as the organizerId.
     *   - auth.uid: 'user123'
     *   - request.resource.data.organizerId: 'user123'
     * @deny (update) User tries to update an event they don't own.
     *   - auth.uid: 'user456'
     *   - resource.data.organizerId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.organizerId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.organizerId == request.auth.uid && resource != null;
    }

    /**
     * @description Rules for community feed posts.
     * @path /community_feed/{postId}
     * @allow (create) User creates a post with their ID as the authorId.
     *   - auth.uid: 'user123'
     *   - request.resource.data.authorId: 'user123'
     * @deny (update) User tries to update a post they don't own.
     *   - auth.uid: 'user456'
     *   - resource.data.authorId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid && resource != null;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid && resource != null;
    }

    /**
     * @description Rules for reports.
     * @path /reports/{reportId}
     * @allow (create) Authenticated user can create a report.
     *   - auth.uid: 'user123'
     * @deny (update) Non-admin user tries to update a report.
     *   - auth.uid: 'user456'
     * @principle Restricts report updates to admins.
     */
    match /reports/{reportId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rules for transactions.
     * @path /transactions/{transactionId}
     * @allow (create) Authenticated user can create a transaction.
     *   - auth.uid: 'user123'
     * @deny (update) Non-admin user tries to update a transaction.
     *   - auth.uid: 'user456'
     * @principle Limits transaction updates to admins.
     */
    match /transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin() && resource != null;
      allow delete: if false;
    }

    /**
     * @description Rules for admin roles.
     * @path /roles_admin/{userId}
     * @allow (create) User creates their own admin role document (to elevate themselves).
     *   - auth.uid: 'admin123'
     * @deny (delete) Non-admin user attempts to delete an admin role document.
     *   - auth.uid: 'nonAdmin456'
     * @principle Grants admin privileges based on document existence.
     */
    match /roles_admin/{userId} {
        allow get, list: if isAdmin();
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if false;
        allow delete: if isAdmin() && resource != null;
    }
  }
}