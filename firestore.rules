rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user creates their own profile.
     * @allow (get, update, delete) Authenticated user accesses their own profile.
     * @deny (create) Authenticated user attempts to create a profile for another user.
     * @deny (get, update, delete) Authenticated user attempts to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow get, update, delete: if isSignedIn() && isOwner(userId);
      allow list: if false;
    }

    /**
     * @description Allows public read access to listings while restricting modifications to the seller.
     * @path /listings/{listingId}
     * @allow (get, list) Anyone can read listings.
     * @allow (create) Authenticated user creates a listing with their seller ID.
     * @allow (update, delete) Authenticated user updates or deletes their own listing.
     * @deny (create) Authenticated user creates a listing with another user's seller ID.
     * @deny (update, delete) Authenticated user attempts to modify another user's listing.
     * @principle Allows public read access with owner-only writes.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Enforces access control for chat conversations based on participant membership.
     * @path /chats/{chatId}
     * @allow (get, list) Authenticated user is a participant in the chat.
     * @allow (create) Authenticated user creates a new chat they are a participant of.
     * @allow (update, delete) Authenticated user is a participant in the chat.
     * @deny (get, list, create, update, delete) Authenticated user is not a participant in the chat.
     * @principle Restricts access to shared resources based on membership.
     */
    match /chats/{chatId} {
      allow get, list: if isSignedIn() && isParticipant(chatId);
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update, delete: if isSignedIn() && isParticipant(chatId);
    }

    /**
     * @description Enforces access control for chat messages based on chat participant membership.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) Authenticated user is a participant in the parent chat.
     * @allow (create) Authenticated user is a participant in the parent chat and the message's sender ID matches their UID.
     * @allow (update, delete) Not allowed.
     * @deny (get, list, create) Authenticated user is not a participant in the parent chat.
     * @principle Restricts access to subcollections based on parent document membership.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn() && isParticipant(chatId);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Allows anyone to read and create reviews. No restrictions on updates or deletes.
     * @path /reviews/{reviewId}
     * @allow (get, list, create, update, delete) Anyone can read, write, and delete reviews.
     * @principle Allows public read and write access for reviews.
     */
    match /reviews/{reviewId} {
      allow get, list, create, update, delete: if true;
    }

    /**
     * @description Enforces access control for events based on the organizer.
     * @path /events/{eventId}
     * @allow (get, list) Anyone can read events.
     * @allow (create) Authenticated user creates an event with their organizer ID.
     * @allow (update, delete) Authenticated user updates or deletes their own event.
     * @deny (create) Authenticated user creates an event with another user's organizer ID.
     * @deny (update, delete) Authenticated user attempts to modify another user's event.
     * @principle Allows public read access with owner-only writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to community feed posts, but restricts modifications to the author.
     * @path /community_feed/{postId}
     * @allow (get, list) Anyone can read community feed posts.
     * @allow (create) Authenticated user creates a post with their author ID.
     * @allow (update, delete) Authenticated user updates or deletes their own post.
     * @deny (create) Authenticated user creates a post with another user's author ID.
     * @deny (update, delete) Authenticated user attempts to modify another user's post.
     * @principle Allows public read access with owner-only writes.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows anyone to create reports.
     * @path /reports/{reportId}
     * @allow (get, list, create, update, delete) Anyone can read, write, and delete reports.
     * @principle Allows public read and write access for reports.
     */
    match /reports/{reportId} {
      allow get, list, create, update, delete: if true;
    }

    /**
     * @description Allows anyone to create transactions.
     * @path /transactions/{transactionId}
     * @allow (get, list, create, update, delete) Anyone can read, write, and delete transactions.
     * @principle Allows public read and write access for transactions.
     */
    match /transactions/{transactionId} {
      allow get, list, create, update, delete: if true;
    }

     /**
      * @description Manages admin roles. The existence of a document grants admin privileges.
      * @path /roles_admin/{userId}
      * @allow (get, list) Only admins can list or read admin roles.
      * @allow (create) Only admins can create admin roles.
      * @allow (update, delete) Only admins can remove admin roles.
      * @deny (get, list, create, update, delete) Non-admins are denied all access.
      * @principle Restricts access to admin roles to existing admins.
      */
    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isParticipant(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}