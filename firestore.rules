/**
 * @fileoverview Firestore Security Rules for the Student Marketplace.
 *
 * Core Philosophy:
 * This ruleset prioritizes a strict authorization model based on user ownership and explicit shared access.
 * All writes are protected by identity checks, and reads are restricted to authorized users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 * - /listings/{listingId}: Stores listings, with owner-only write access.
 * - /chats/{chatId}: Stores chat metadata. Access is controlled by a `participants` array.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within chats. Access is controlled by the parent chat's `participants` array.
 * - /reviews/{reviewId}: Stores reviews, writable by the buyer, readable by all.
 * - /events/{eventId}: Stores event data, writable by the organizer, readable by all.
 * - /community_feed/{postId}: Stores community feed posts, writable by the author, readable by all.
 * - /reports/{reportId}: Stores reports, only writable, not readable by users.
 * - /transactions/{transactionId}: Stores transaction data, not readable or writable by users.
 * - /roles_admin/{userId}: Stores admin roles. Existence implies admin privileges.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Public read access is granted to the listings, events, and community feed collections.
 * - The `roles_admin` collection manages global admin privileges.
 *
 * Denormalization for Authorization:
 * - Listings store the `sellerId` to avoid `get()` calls for ownership checks.
 * - Chats store a `participants` array for efficient access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing resource.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user is a participant in the chat.
     */
    function isChatParticipant(participantIds) {
        return isSignedIn() && participantIds.hasAny([request.auth.uid]);
    }

    /**
     * @description Checks if the user has admin privileges.
     * @details This function checks for the existence of a document in the `/roles_admin/{userId}` collection with the user's UID as the document ID.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - If the user's UID matches the userId in the path.
     * @allow (get, update, delete) - If the user's UID matches the userId in the path.
     * @deny (create) - If the user's UID does not match the userId in the path.
     * @deny (get, update, delete) - If the user's UID does not match the userId in the path.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users

      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /listings/{listingId} collection.
     * @path /listings/{listingId}
     * @allow (get, list) - Anyone can read listings.
     * @allow (create) - Only authenticated users can create listings.
     * @allow (update, delete) - Only the owner (seller) can update or delete listings.
     * @deny (create) - If the authorId field does not match the user's UID.
     * @deny (update, delete) - If the user is not the owner (seller).
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Rules for the /chats/{chatId} collection.
     * @path /chats/{chatId}
     * @allow (get, list) - Only participants can read chats.
     * @allow (create) - Only authenticated users can create chats.  The create request must include the request user's UID in the list of participants.
     * @allow (update, delete) - Only participants can update or delete chats. The user must be an owner of the chat resource to delete it.
     * @deny (create) - If the user is not included in the participants array.
     * @deny (update, delete) - If the user is not a participant.
     * @principle Enforces access control based on chat participation.
     */
    match /chats/{chatId} {
      allow get, list: if isChatParticipant(resource.data.participants);
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isChatParticipant(resource.data.participants);
      allow delete: if isChatParticipant(resource.data.participants);
    }

    /**
     * @description Rules for the /chats/{chatId}/messages/{messageId} collection.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) - Only participants of the parent chat can read messages.
     * @allow (create) - Only participants of the parent chat can create messages.
     * @allow (update, delete) - No user can update or delete messages, to preserve message history.
     * @deny (create) - If the user is not a participant of the parent chat.
     * @deny (update, delete) - Always deny message updates and deletes.
     * @principle Enforces access control based on parent chat participation. Messages are immutable.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      allow create: if isSignedIn() && isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants) && request.resource.data.senderId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Rules for the /reviews/{reviewId} collection.
     * @path /reviews/{reviewId}
     * @allow (get, list) - Anyone can read reviews.
     * @allow (create) - Only authenticated users can create reviews, and the buyerId must match the user's UID.
     * @allow (update, delete) - No one can update or delete review, as they are immutable.
     * @deny (create) - If the buyerId does not match the user's UID.
     * @deny (update, delete) - Always deny review updates and deletes.
     * @principle Allows public reads and owner-only writes, with immutability.
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;
      allow update, delete: if false;
    }

    /**
     * @description Rules for the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (get, list) - Anyone can read event details.
     * @allow (create) - Only authenticated users can create events. The organizerId field must match the user's UID.
     * @allow (update, delete) - Only the event organizer can update or delete the event.
     * @deny (create) - If the organizerId field does not match the user's UID.
     * @deny (update, delete) - If the user is not the organizer.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.organizerId);
      allow delete: if isExistingOwner(resource.data.organizerId);
    }

    /**
     * @description Rules for the /community_feed/{postId} collection.
     * @path /community_feed/{postId}
     * @allow (get, list) - Anyone can read community feed posts.
     * @allow (create) - Only authenticated users can create posts. The authorId field must match the user's UID.
     * @allow (update, delete) - Only the author of the post can update or delete it.
     * @deny (create) - If the authorId field does not match the user's UID.
     * @deny (update, delete) - If the user is not the author.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Rules for the /reports/{reportId} collection.
     * @path /reports/{reportId}
     * @allow (create) - Only authenticated users can create reports.
     * @deny (get, list, update, delete) - No one can read, list, update, or delete reports.
     * @principle Restricts all access to reports except for creation.
     */
    match /reports/{reportId} {
      allow get, list, update, delete: if false;
      allow create: if isSignedIn();
    }

    /**
     * @description Rules for the /transactions/{transactionId} collection.
     * @path /transactions/{transactionId}
     * @deny (get, list, create, update, delete) - No one can read, list, create, update, or delete transactions.
     * @principle Completely restricts access to transaction data.
     */
    match /transactions/{transactionId} {
      allow get, list, create, update, delete: if false;
    }

     /**
      * @description Rules for the /roles_admin/{userId} collection.
      * @path /roles_admin/{userId}
      * @allow get: if isAdmin(); // Admins can check for other admins
      * @allow list: if false;
      * @allow create: if isSignedIn(); // Allow creation (claiming admin)
      * @allow update: if false;
      * @allow delete: if false;
      */
     match /roles_admin/{userId} {
       allow get: if isAdmin();
       allow list: if false;
       allow create: if isAdmin();
       allow update: if false;
       allow delete: if false;
     }
  }
}