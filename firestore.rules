/**
 * @fileOverview
 * This ruleset enforces a user-centric security model for the Nexus Student Marketplace.
 * All data is organized into top-level collections: `users`, `listings`, `transactions`, `reviews`, and `messages`.
 *
 * Core Philosophy:
 *  - Authenticated users can read all user profiles.
 *  - Users can only modify their own profile data.
 *  - Listings are publicly readable, but only the seller can modify them.
 *  - Messages are only accessible to authenticated users.
 *
 * Data Structure:
 *  - `/users/{userId}`: Stores user profiles.
 *  - `/listings/{listingId}`: Stores listings.  Each listing contains a `sellerId` field for authorization.
 *  - `/transactions/{transactionId}`: Stores transaction data.
 *  - `/reviews/{reviewId}`: Stores reviews.
 *  - `/messages/{messageId}`: Stores chat messages.
 *
 * Key Security Decisions:
 *  - User listing is allowed by authenticated users.
 *  - All write operations require authentication.
 *  - `listings` documents require a `sellerId` field that matches the authenticated user's UID for update/delete operations.
 *
 * Denormalization for Authorization:
 *  - The `listings` collection denormalizes the `sellerId` field within each document. This allows for efficient ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (read) request.auth != null. Allows any authenticated user to read a user profile.
     * @allow (create, update, delete) request.auth != null && request.auth.uid == userId. Allows a user to create, update, or delete their own profile.
     * @deny (create, update, delete) request.auth == null.  Denies unauthenticated users from creating, updating, or deleting user profiles.
     * @deny (create, update, delete) request.auth.uid != userId. Denies users from modifying profiles that don't belong to them.
     * @principle Enforces user-ownership for profile writes and authenticated read access.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to listings.
     * @path /listings/{listingId}
     * @allow (read) true. Allows anyone to read listings.
     * @allow (create) request.auth != null. Allows authenticated users to create listings.
     * @allow (update, delete) request.auth != null && request.auth.uid == resource.data.sellerId. Allows only the seller to update or delete their own listings.
     * @deny (update, delete) request.auth == null. Denies unauthenticated users from updating or deleting listings.
     * @deny (update, delete) request.auth.uid != resource.data.sellerId. Denies users from modifying listings that don't belong to them.
     * @principle Enforces public read access with owner-only writes for listings.
     */
    match /listings/{listingId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() ;
      allow update: if isSignedIn() && isExistingOwner(resource.data.sellerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Controls access to transactions.
     * @path /transactions/{transactionId}
     * @allow (read, write) request.auth != null. Allows any authenticated user to read or write transactions.
     * @deny (read, write) request.auth == null. Denies unauthenticated users from reading or writing transactions.
     * @principle Requires authentication for all access to transactions.
     */
    match /transactions/{transactionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to reviews.
     * @path /reviews/{reviewId}
     * @allow (read, write) request.auth != null. Allows any authenticated user to read or write reviews.
     * @deny (read, write) request.auth == null. Denies unauthenticated users from reading or writing reviews.
     * @principle Requires authentication for all access to reviews.
     */
    match /reviews/{reviewId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to chat messages.
     * @path /messages/{messageId}
     * @allow (read, write) request.auth != null. Allows any authenticated user to read or write chat messages.
     * @deny (read, write) request.auth == null. Denies unauthenticated users from reading or writing chat messages.
     * @principle Requires authentication for all access to chat messages.
     */
    match /messages/{messageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // DEFAULT FALLBACK
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }

  // Helper function to determine if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the existing owner of the resource
  function isExistingOwner(ownerId) {
    return isSignedIn() && request.auth.uid == ownerId && resource != null;
  }
}