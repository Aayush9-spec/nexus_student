/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure-by-default approach, focusing on strict
 * authorization and leveraging denormalization to avoid costly `get()` calls.
 * Access is generally restricted to owners of data, with exceptions for public
 * read access on certain top-level collections.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles; access is restricted to the owning user.
 * - /listings/{listingId}: Stores listings, with public read access and owner-only write access.
 * - /chats/{chatId}: Stores chat conversations, secured via a `participants` array.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within chats, accessible only to chat participants.
 * - /reviews/{reviewId}: Stores reviews, with access limited to the buyer or seller involved.
 * - /events/{eventId}: Stores event information, with owner-only write access.
 * - /community_feed/{postId}: Stores community feed posts, with owner-only write access.
 * - /reports/{reportId}: Stores reports, with restricted write access.
 * - /transactions/{transactionId}: Stores transaction data, with restricted write access.
 * - /roles_admin/{userId}: Stores admin roles; existence of a document grants admin privileges.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Public read access is granted to the `listings` and `community_feed` collections.
 * - The `participants` array is used to secure chat access, enabling efficient authorization.
 * - Admin roles are managed through the existence of documents in the `roles_admin` collection.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to allow rules to validate ownership without `get()` calls.
 * - Chats include a `participants` array to explicitly define the participants, ensuring only authorized users can access chat data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to user profiles based on ownership.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile at /users/user123.
     * @allow (get) User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (get) User with UID 'user456' cannot read the profile at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to listings, but restricts writes to the owner.
     * @path /listings/{listingId}
     * @allow (get) Any user can read a listing.
     * @allow (list) Any user can list listings.
     * @allow (create) User with UID 'user123' can create a listing with sellerId 'user123'.
     * @allow (update) User with UID 'user123' can update a listing with sellerId 'user123'.
     * @allow (delete) User with UID 'user123' can delete a listing with sellerId 'user123'.
     * @deny (create) User with UID 'user456' cannot create a listing with sellerId 'user123'.
     * @principle Allows public read access while enforcing owner-only write access.
     */
    match /listings/{listingId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == resource.data.sellerId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && isOwner();
      allow delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Manages access to chat conversations based on participant membership.
     * @path /chats/{chatId}
     * @allow (get) User with UID 'user123' can read a chat if they are a participant.
     * @allow (list) User with UID 'user123' can list chats if they are a participant.
     * @allow (create) User with UID 'user123' can create a chat if they are a participant.
     * @allow (update) User with UID 'user123' can update a chat if they are a participant and updating `lastMessage`.
     * @allow (delete) User with UID 'user123' can delete a chat if they are a participant.
     * @deny (get) User with UID 'user456' cannot read the chat if they are not a participant.
     * @principle Enforces shared access through participant membership.
     */
    match /chats/{chatId} {
      function isParticipant() {
        return request.auth != null && request.auth.uid in resource.data.participants;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isParticipant();
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isParticipant();
      allow delete: if isParticipant();
    }

    /**
     * @description Secures messages within a chat, allowing access only to chat participants.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) User with UID 'user123' can read a message if they are a participant in the chat.
     * @allow (list) User with UID 'user123' can list messages if they are a participant in the chat.
     * @allow (create) User with UID 'user123' can create a message if they are a participant in the chat and senderId is their uid.
     * @deny (create) User with UID 'user456' cannot create a message in a chat they are not a participant of.
     * @principle Enforces shared access through participant membership in the parent chat.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isChatParticipant(chatId) {
          return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId) && request.resource.data.senderId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to reviews, allowing access only to the buyer or seller.
     * @path /reviews/{reviewId}
     * @allow (get) User with UID 'user123' can read a review if they are the buyer or seller.
     * @allow (list) User with UID 'user123' can list reviews if they are the buyer or seller.
     * @allow (create) User with UID 'user123' can create a review if they are the buyer and the buyerId in review doc is them.
     * @deny (create) User with UID 'user456' cannot create a review for seller 'user123'.
     * @principle Restricts access to the buyer and seller involved in the review.
     */
    match /reviews/{reviewId} {
      function isBuyerOrSeller() {
        return request.auth != null && (request.auth.uid == resource.data.sellerId || request.auth.uid == resource.data.buyerId);
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn() && isBuyerOrSeller();
      allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to events, restricting writes to the organizer.
     * @path /events/{eventId}
     * @allow (get) Any user can read an event.
     * @allow (list) Any user can list events.
     * @allow (create) User with UID 'user123' can create an event with organizerId 'user123'.
     * @allow (update) User with UID 'user123' can update an event with organizerId 'user123'.
     * @allow (delete) User with UID 'user123' can delete an event with organizerId 'user123'.
     * @deny (create) User with UID 'user456' cannot create an event with organizerId 'user123'.
     * @principle Enforces owner-only write access to events.
     */
    match /events/{eventId} {
      function isOrganizer() {
        return request.auth != null && request.auth.uid == resource.data.organizerId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && isOrganizer();
      allow delete: if isSignedIn() && isOrganizer();
    }

    /**
     * @description Controls access to community feed posts, restricting writes to the author.
     * @path /community_feed/{postId}
     * @allow (get) Any user can read a community feed post.
     * @allow (list) Any user can list community feed posts.
     * @allow (create) User with UID 'user123' can create a post with authorId 'user123'.
     * @allow (update) User with UID 'user123' can update a post with authorId 'user123'.
     * @allow (delete) User with UID 'user123' can delete a post with authorId 'user123'.
     * @deny (create) User with UID 'user456' cannot create a post with authorId 'user123'.
     * @principle Enforces owner-only write access to community feed posts.
     */
    match /community_feed/{postId} {
      function isAuthor() {
        return request.auth != null && request.auth.uid == resource.data.authorId;
      }
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isAuthor();
      allow delete: if isSignedIn() && isAuthor();
    }

    /**
     * @description Restricts access to reports, limiting write access.
     * @path /reports/{reportId}
     * @allow (get) Any user can read a report.
     * @allow (list) Any user can list reports.
     * @deny (create) No user can create a report.  // TODO: Define more granular report creation rules.
     * @principle Restricts access to reports.
     */
    match /reports/{reportId} {
        function isSignedIn() {
          return request.auth != null;
        }
      allow get, list: if true;
      allow create: if false; // TODO: Define more granular report creation rules.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to transactions, limiting write access.
     * @path /transactions/{transactionId}
     * @allow (get) Any user can read a transaction.
     * @allow (list) Any user can list transactions.
     * @deny (create) No user can create a transaction. // TODO: Define more granular transaction creation rules.
     * @principle Restricts access to transactions.
     */
    match /transactions/{transactionId} {
        function isSignedIn() {
          return request.auth != null;
        }
      allow get, list: if true;
      allow create: if false; // TODO: Define more granular transaction creation rules.
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages admin roles based on document existence.
     * @path /roles_admin/{userId}
     * @allow (get) Only admins can read other admins.
     * @allow (list) Only admins can list other admins.
     * @allow (create) Only admins can create other admins.
     * @deny (create) Non-admins cannot create admin roles.
     *
     * @principle Uses document existence to grant admin privileges.
     */
     match /roles_admin/{userId} {
        function isAdmin() {
          return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }
        function isSignedIn() {
          return request.auth != null;
        }
        allow get, list: if isAdmin();
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if false;
     }
  }
}