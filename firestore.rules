/**
 * @fileoverview Firestore Security Rules for Nexus Student Marketplace.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and listings.
 * Users can only read and write their own profile data. Listings are publicly readable
 * but can only be created, updated, or deleted by their respective owners.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, with the document ID matching the user's UID.
 * - /listings/{listingId}: Stores listings, with a 'sellerId' field indicating the owner.
 * - /transactions/{transactionId}: Stores transaction data, with references to listings, buyers, and sellers.
 * - /reviews/{reviewId}: Stores reviews, associated with a listing and reviewer.
 * - /messages/{messageId}: Stores chat messages between users.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy reasons.
 * - Public read access is granted for listings to enable discovery.
 * - Data validation is limited to ownership checks to ensure relational integrity.
 *
 * Denormalization for Authorization:
 * - The 'Listing' entity denormalizes the 'sellerId' to enable ownership checks
 *   without requiring additional reads.
 *
 * Structural Segregation:
 * - Publicly readable listings are stored in a top-level collection, while user-specific
 *   data is stored under the /users/{userId} path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (get, create, update, delete, list): Authenticated user can access their own profile.
     * @deny (get, create, update, delete, list): Authenticated user tries to access another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to listings.
     * @path /listings/{listingId}
     * @allow (get, list): Public read access for all listings.
     * @allow (create): Authenticated user can create a listing with their UID as the sellerId.
     * @allow (update, delete): Only the owner can update or delete their listing.
     * @deny (create): Authenticated user tries to create a listing with a sellerId that doesn't match their UID.
     * @deny (update, delete): Non-owner attempts to update or delete a listing.
     * @principle Public read with owner-only writes, enforces sellerId ownership.
     */
    match /listings/{listingId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner() {
          return request.auth.uid == resource.data.sellerId;
        }

        function isCreatingWithOwnerId() {
            return request.auth.uid == request.resource.data.sellerId;
        }

        function isExistingOwner() {
            return isOwner() && resource != null;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isCreatingWithOwnerId();
        allow update: if isSignedIn() && isExistingOwner();
        allow delete: if isSignedIn() && isExistingOwner();
    }

     /**
      * @description Controls access to transactions.
      * @path /transactions/{transactionId}
      * @allow (get): Allow anyone to read transactions
      * @allow (create): Allow anyone to create transactions
      * @allow (update): Deny
      * @allow (delete): Deny
      * @allow (list): Deny
      * @principle Currently, no specific ownership is enforced.
      */
    match /transactions/{transactionId} {
        allow get: if true;
        allow list: if false;
        allow create: if true;
        allow update: if false;
        allow delete: if false;
    }

     /**
      * @description Controls access to reviews.
      * @path /reviews/{reviewId}
      * @allow (get): Allow anyone to read reviews.
      * @allow (create): Allow anyone to create reviews
      * @allow (update): Deny
      * @allow (delete): Deny
      * @allow (list): Deny
      * @principle: Currently, no specific ownership is enforced.
      */
    match /reviews/{reviewId} {
        allow get: if true;
        allow list: if false;
        allow create: if true;
        allow update: if false;
        allow delete: if false;
    }

     /**
      * @description Controls access to messages.
      * @path /messages/{messageId}
      * @allow (get): Allow anyone to read messages.
      * @allow (create): Allow anyone to create messages
      * @allow (update): Deny
      * @allow (delete): Deny
      * @allow (list): Deny
      * @principle: Currently, no specific ownership is enforced.
      */
    match /messages/{messageId} {
        allow get: if true;
        allow list: if false;
        allow create: if true;
        allow update: if false;
        allow delete: if false;
    }
  }
}