/**
 * @fileoverview Firestore Security Rules for the Student Marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, user-centric data access model. It enforces
 * strict ownership for user-created content and uses denormalization to simplify
 * authorization checks, avoiding costly and slow `get()` calls. The ruleset
 * is designed to prevent unauthorized data access and modification, while
 * providing flexibility for legitimate user interactions.  It uses Role Based Access Control for administrative functions.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles. Access is restricted to the
 *   user themselves (ownership model).
 * - `/listings/{listingId}`: Stores marketplace listings. Uses a public-read,
 *   owner-write pattern, with ownership determined by the `sellerId` field.
 * - `/chats/{chatId}`: Stores chat metadata. Access is controlled by a
 *   `participants` array within the document, allowing only listed users to
 *   read and write.
 * - `/chats/{chatId}/messages/{messageId}`: Stores individual chat messages.
 *   Access is inherited from the parent chat document, ensuring only chat
 *   participants can access messages.
 * - `/reviews/{reviewId}`: Stores user reviews.  Anyone can create a review, and anyone can read reviews.
 * - `/events/{eventId}`: Stores event information. Uses a public-read,
 *   owner-write pattern, with ownership determined by the `organizerId` field.
 * - `/community_feed/{postId}`: Stores community feed posts. Uses a public-read,
 *   owner-write pattern, with ownership determined by the `authorId` field.
 * - `/reports/{reportId}`: Stores reports of users or content. Access to reports
 *   is restricted and should only be readable or writable by admin roles
 * - `/transactions/{transactionId}`: Stores transaction information.
 * - `/roles_admin/{userId}`: Used to designate administrative users. The
 *   existence of a document signifies admin privileges.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Public read access is granted to the `/listings`, `/events`, and
 *   `/community_feed` collections to enable discovery.
 * - Data validation is minimized in the prototyping phase to allow for rapid
 *   iteration and schema evolution.  Focus is placed on validating authorization fields.
 *
 * Denormalization for Authorization:
 * - The `listings` collection includes the `sellerId` field to allow for
 *   ownership checks without requiring additional reads.
 * - The `chats` collection includes the `participants` array to allow for
 *   authorization checks without needing a separate membership collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     * @return {boolean} True if the user is signed in and the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId - The user ID to compare against the document's owner ID.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin by verifying the existence of a document in the `/roles_admin/{userId}` collection.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile.
     * @allow (get, update, delete) - Authenticated user accesses their own profile.
     * @deny (create) - Unauthenticated user attempts to create a profile.
     * @deny (get, update, delete) - Authenticated user attempts to access another user's profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /listings/{listingId} collection.
     * @path /listings/{listingId}
     * @allow (get, list) - Anyone can read listings.
     * @allow (create) - Authenticated user creates a listing with their ID as sellerId.
     * @allow (update, delete) - Only the seller can update or delete the listing.
     * @deny (create) - Authenticated user creates a listing with a sellerId that doesn't match their UID.
     * @deny (update, delete) - Another authenticated user attempts to modify someone else's listing.
     * @principle Public read, owner-only writes.  Validates ownership on create, update, and delete.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Rules for the /chats/{chatId} collection.
     * @path /chats/{chatId}
     * @allow (get, list) - Only participants can read chats.
     * @allow (create, update) - Only participants can create or update chats.
     * @allow (delete) - Only participants can delete chats.
     * @deny (get, list) - User not in the `participants` array attempts to read a chat.
     * @deny (create, update, delete) - User not in the `participants` array attempts to modify a chat.
     * @principle Shared access (closed collaborators).  Uses a `participants` array for authorization.
     */
    match /chats/{chatId} {
      allow get, list: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if isSignedIn() && request.auth.uid in resource.data.participants;
    }

    /**
     * @description Rules for the /chats/{chatId}/messages/{messageId} collection.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) - Only participants of the parent chat can read messages.
     * @allow (create) - Only participants of the parent chat can create messages.
     * @allow (update, delete) - No updates or deletes are allowed once a message is created.
     * @deny (get, list) - User not in the parent chat's `participants` array attempts to read messages.
     * @deny (create) - User not in the parent chat's `participants` array attempts to create messages.
     * @principle Shared access inherited from parent.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow update, delete: if false;
    }

    /**
     * @description Rules for the /reviews/{reviewId} collection.
     * @path /reviews/{reviewId}
     * @allow (get, list) - Anyone can read reviews.
     * @allow (create) - Any signed in user can leave reviews.
     * @deny (update, delete) - Reviews cannot be edited nor deleted
     * @principle Public read, authenticated creation, immutable.
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Rules for the /events/{eventId} collection.
     * @path /events/{eventId}
     * @allow (get, list) - Anyone can read events.
     * @allow (create) - Authenticated user creates an event with their ID as organizerId.
     * @allow (update, delete) - Only the organizer can update or delete the event.
     * @deny (create) - Authenticated user creates an event with an organizerId that doesn't match their UID.
     * @deny (update, delete) - Another authenticated user attempts to modify someone else's event.
     * @principle Public read, owner-only writes. Validates ownership on create, update, and delete.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.organizerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Rules for the /community_feed/{postId} collection.
     * @path /community_feed/{postId}
     * @allow (get, list) - Anyone can read community feed posts.
     * @allow (create) - Authenticated user creates a post with their ID as authorId.
     * @allow (update, delete) - Only the author can update or delete the post.
     * @deny (create) - Authenticated user creates a post with an authorId that doesn't match their UID.
     * @deny (update, delete) - Another authenticated user attempts to modify someone else's post.
     * @principle Public read, owner-only writes. Validates ownership on create, update, and delete.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Rules for the /reports/{reportId} collection.
     * @path /reports/{reportId}
     * @allow (get, list, create, update, delete) - Only admins can manage reports.
     * @deny (get, list, create, update, delete) - Non-admins cannot manage reports.
     * @principle Role-based access control.
     */
    match /reports/{reportId} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /transactions/{transactionId} collection.
     * @path /transactions/{transactionId}
     * @allow get: if isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
     * @allow list: if false;
     * @allow create: if isSignedIn() && (request.resource.data.buyerId == request.auth.uid || request.resource.data.sellerId == request.auth.uid);
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Only buyer or seller can read the transaction. No listing, updating or deleting.
     */
    match /transactions/{transactionId} {
      allow get: if isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn() && (request.resource.data.buyerId == request.auth.uid || request.resource.data.sellerId == request.auth.uid);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     * @allow get, list, create, update, delete: if false;
     * @principle Only accessible by backend functions.
     */
    match /roles_admin/{userId} {
      allow get, list, create, update, delete: if false;
    }
  }
}