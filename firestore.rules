rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their profile.
     * @allow (get, update, delete) User with matching UID can access their profile.
     * @deny (create) User cannot create a profile with a different UID.
     * @deny (get, update, delete) User cannot access another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to listings.
     * @path /listings/{listingId}
     * @allow (get, list) Any user can read listings.
     * @allow (create) User can create listing if sellerId matches their UID.
     * @allow (update, delete) Only the seller can update or delete their listing.
     * @deny (create) User cannot create a listing for another seller.
     * @deny (update, delete) User cannot modify or delete a listing they don't own.
     * @principle Allows public reads, enforces ownership for writes.
     */
    match /listings/{listingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(sellerId) {
        return request.auth.uid == sellerId;
      }

       function isExistingOwner() {
        return isSignedIn() && request.auth.uid == resource.data.sellerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Controls access to chats.
     * @path /chats/{chatId}
     * @allow (get, list) Only participants can read/list chat.
     * @allow (create) User can create chat if participantIds includes their UID.
     * @allow (update, delete) No one can update/delete chat after it is created.
     * @deny (create) User cannot create a chat without themselves as a participant.
     * @deny (get, list) User cannot read/list a chat they don't belong to.
     * @principle Enforces shared access based on membership.
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }

      allow get: if isSignedIn() && isParticipant();
      allow list: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get, list) Only participants of the chat can read/list messages.
     * @allow (create) Only participants can create messages.
     * @deny (get, list, create) Users not in the chat cannot access messages.
     * @principle Enforces shared access based on membership in the parent chat.
     */
    match /chats/{chatId}/messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isChatParticipant(chatId) {
        return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isSignedIn() && isChatParticipant(chatId);
      allow list: if isSignedIn() && isChatParticipant(chatId);
      allow create: if isSignedIn() && isChatParticipant(chatId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to reviews.
     * @path /reviews/{reviewId}
     * @allow (get, list) Anyone can read/list reviews.
     * @allow (create) User can create review.
     * @deny (update, delete) No one can update/delete reviews.
     * @principle Allows public reads, restricts writes.
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to events.
     * @path /events/{eventId}
     * @allow (get, list) Any user can read/list events.
     * @allow (create) User can create an event if organizerId matches their UID.
     * @allow (update, delete) Only the organizer can update or delete their event.
     * @deny (create) User cannot create an event for another organizer.
     * @deny (update, delete) User cannot modify or delete an event they don't own.
     * @principle Allows public reads, enforces ownership for writes.
     */
    match /events/{eventId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(organizerId) {
        return request.auth.uid == organizerId;
      }

      function isExistingOwner() {
        return isSignedIn() && request.auth.uid == resource.data.organizerId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Controls access to community feed posts.
     * @path /community_feed/{postId}
     * @allow (get, list) Any user can read/list community feed posts.
     * @allow (create) User can create a post if authorId matches their UID.
     * @allow (update, delete) Only the author can update or delete their post.
     * @deny (create) User cannot create a post for another author.
     * @deny (update, delete) User cannot modify or delete a post they don't own.
     * @principle Allows public reads, enforces ownership for writes.
     */
    match /community_feed/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(authorId) {
        return request.auth.uid == authorId;
      }

      function isExistingOwner() {
        return isSignedIn() && request.auth.uid == resource.data.authorId;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Controls access to reports.
     * @path /reports/{reportId}
     * @allow (create) Only authenticated users can create reports.
     * @deny (get, list, update, delete) Nobody can get, list, update, or delete reports.
     * @principle Restricts read/write access to reports collection.
     */
    match /reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to transactions.
     * @path /transactions/{transactionId}
     * @allow (create) Only authenticated users can create transactions.
     * @deny (get, list, update, delete) Nobody can get, list, update, or delete transactions.
     * @principle Restricts read/write access to transactions collection.
     */
    match /transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

        /**
         * @description Controls access to admin roles. Only admins can access the roles_admin collection.
         * @path /roles_admin/{userId}
         * @allow (create) User with matching UID can create their admin role.
         * @allow (get, update, delete) User with matching UID can access their admin role.
         * @deny (create) User cannot create an admin role with a different UID.
         * @deny (get, update, delete) User cannot access another user's admin role.
         * @principle Enforces document ownership for admin roles.
         */
      match /roles_admin/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isAdmin(userId) {
          return request.auth.uid == userId;
        }

        function isExistingAdmin(userId) {
          return isSignedIn() && request.auth.uid == userId;
        }

        allow get: if isSignedIn() && isExistingAdmin(userId);
        allow list: if false; // Listing admin roles is not permitted.
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if isSignedIn() && isExistingAdmin(userId);
        allow delete: if isSignedIn() && isExistingAdmin(userId);
      }
  }
}