/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-only access model for user data and a role-based access model for collaborative features like chats. Data denormalization is used extensively to avoid costly `get()` calls in security rules.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.  Access is restricted to the user identified by {userId}.
 * - /listings/{itemId}: Stores marketplace listings. Readable by all, writable by authenticated users with sellerId matching their UID.
 * - /chats/{chatId}: Stores chat metadata.  Access is controlled via a 'participants' array within the document, granting access to listed users.
 * - /chats/{chatId}/messages/{messageId}: Stores individual chat messages. Access is inherited from the parent chat document's participants list.
 * - /reviews/{reviewId}: Stores reviews of sellers.
 * - /events/{eventId}: Stores event information. Includes `organizerId` for authorization.
 * - /community_feed/{postId}: Stores community feed posts. Includes `authorId` for authorization.
 * - /reports/{reportId}: Stores reports of users or content.
 * - /transactions/{transactionId}: Stores transaction information related to transactions between two users or more.
 * - /roles_admin/{userId}: Stores admin roles. The existence of a document with the user's ID indicates admin privileges.
 *
 * Key Security Decisions:
 * - User listing is implicitly denied due to the owner-only access pattern on /users/{userId}.
 * - Public read access is granted to the /marketplace collection.
 * - Role-based access is enforced for chats via the 'participants' array.
 * - Strict ownership is enforced on user-owned data trees.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to allow rules to validate ownership without additional reads.
 * - Chats include a `participants` array for efficient access control.
 *
 * Structural Segregation:
 * - User profiles are stored under /users/{userId} for private access.
 * - Marketplace listings are stored under /marketplace/{itemId} for public read access with owner-only writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows each user to read and write their own user document.
     * @path /users/{userId}
     * @allow (read, write) if request.auth.uid == userId
     * @deny (read, write) if request.auth.uid != userId
     * @principle Enforces document ownership for reads and writes.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing user documents is not permitted.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.uid == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read marketplace items, but only authenticated users can create, update, or delete them, if they are the owner.
     * @path /listings/{itemId}
     * @allow (read) always
     * @allow (create) if request.auth != null && request.resource.data.sellerId == request.auth.uid
     * @allow (update) if request.auth != null && resource.data.sellerId == request.auth.uid
     * @deny (create, update, delete) if request.auth == null or user isn't the owner
     * @principle Allows public read access while restricting write access to owners.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Allows only participants of a chat to read and write to the chat document.
     * @path /chats/{chatId}
     * @allow (read, write) if request.auth != null && request.auth.uid in resource.data.participants
     * @deny (read, write) if request.auth == null or user isn't a participant
     * @principle Enforces shared access control for collaborative resources.
     */
    match /chats/{chatId} {
      allow get, list: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if isSignedIn() && request.auth.uid in resource.data.participants;
    }

    /**
     * @description Allows only participants of a chat to read and write messages in the chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (read, write) if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
     * @deny (read, write) if request.auth == null or user isn't a participant of the parent chat
     * @principle Enforces shared access control for collaborative resources.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Allows anyone to read reviews, but only authenticated users can create them.
     * @path /reviews/{reviewId}
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read events, but only authenticated users can create, update, or delete them if they are the organizer.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.organizerId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Allows anyone to read community feed posts, but only authenticated users can create them.
     * @path /community_feed/{postId}
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows only authenticated users can create reports.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows only authenticated users can create transactions.
     * @path /transactions/{transactionId}
     */
    match /transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
    
    /**
     * @description Allows only admin users to get information. The existence of a document with the user's ID indicates admin privileges.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the document.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner of the document and the document exists.
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}