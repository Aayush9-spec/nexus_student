/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access by enforcing strict ownership and role-based access control.
 * It leverages denormalization to avoid costly `get()` calls and simplify authorization checks.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles. Each user can only access their own profile.
 * - `/listings/{listingId}`: Stores listings. Anyone can read listings, but only the seller can modify them.
 * - `/chats/{chatId}`: Stores chat metadata. Only participants can access a chat.
 * - `/chats/{chatId}/messages/{messageId}`: Stores messages within a chat. Only chat participants can access messages.
 * - `/reviews/{reviewId}`: Stores reviews. No specific access control is enforced beyond authentication for writes.
 * - `/events/{eventId}`: Stores events. Anyone can read events, but only the organizer can modify them.
 * - `/community_feed/{postId}`: Stores community feed posts. Anyone can read posts, but only the author can modify them.
 * - `/reports/{reportId}`: Stores reports. No specific access control is enforced beyond authentication for writes.
 * - `/transactions/{transactionId}`: Stores transaction data. No specific access control is enforced beyond authentication for writes.
 * - `/roles_admin/{userId}`: Stores admin roles. The existence of a document with the user's ID indicates admin privileges.
 *
 * Key Security Decisions:
 * - **Ownership Enforcement**: Most write operations are restricted to the owner of the data.
 * - **Public Read Access**: Some collections (e.g., `/listings`, `/events`, `/community_feed`) allow public read access.
 * - **Chat Access Control**: Chat access is controlled by a membership list within the chat document.
 * - **Admin Roles**: Admin roles are managed through a dedicated collection.
 * - **No User Listing**: Listing all users is not allowed to prevent scraping.
 *
 * Denormalization for Authorization:
 * - Listings store the `sellerId` to allow ownership checks without additional reads.
 * - Chats store the `participants` list to authorize access to the chat and its messages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-only access to user profiles.
     * @path /users/{userId}
     * @allow (read,write) User with ID 'user123' can read and write their own profile.
     * @deny (read,write) User with ID 'user456' cannot read or write 'user123's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to listings, but restricts modifications to the seller.
     * @path /listings/{listingId}
     * @allow (read) Any user can read any listing.
     * @allow (create) User with ID 'user123' can create a listing with `sellerId: 'user123'`.
     * @allow (update,delete) User with ID 'user123' can update/delete a listing where `resource.data.sellerId == 'user123'`.
     * @deny (create) User with ID 'user123' cannot create a listing with `sellerId: 'user456'`.
     * @deny (update,delete) User with ID 'user456' cannot update/delete a listing where `resource.data.sellerId == 'user123'`.
     * @principle Allows public read access with owner-only writes.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.sellerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Restricts access to chats to only the participants.
     * @path /chats/{chatId}
     * @allow (read,write) User with ID 'user123' can read and write the chat if they are in the `participants` list.
     * @deny (read,write) User with ID 'user456' cannot read or write the chat if they are not in the `participants` list.
     * @principle Enforces shared access between a defined set of collaborators.
     */
    match /chats/{chatId} {
      allow get, list: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow create: if isSignedIn() && request.resource.data.participants.hasAll([request.auth.uid]);
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if false; // Deletion is disallowed for chats
    }

    /**
     * @description Restricts access to messages within a chat to only the chat participants.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (read,write) User with ID 'user123' can read and write messages in the chat if they are a participant.
     * @deny (read,write) User with ID 'user456' cannot read or write messages if they are not a participant.
     * @principle Inherits access control from the parent chat document.
     */
    match /chats/{chatId}/messages/{messageId} {
      allow get, list: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) && request.resource.data.chatId == chatId;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
      allow delete: if false; // Deletion is disallowed for messages
    }

    /**
     * @description Allows authenticated users to create, update, and delete reviews. No ownership enforced.
     * @path /reviews/{reviewId}
     * @allow (create,update,delete) Any authenticated user can create, update, and delete reviews.
     * @principle Requires authentication for writes, but does not enforce ownership.
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to events, but restricts modifications to the organizer.
     * @path /events/{eventId}
     * @allow (read) Any user can read any event.
     * @allow (create) User with ID 'user123' can create an event with `organizerId: 'user123'`.
     * @allow (update,delete) User with ID 'user123' can update/delete an event where `resource.data.organizerId == 'user123'`.
     * @deny (create) User with ID 'user123' cannot create an event with `organizerId: 'user456'`.
     * @deny (update,delete) User with ID 'user456' cannot update/delete an event where `resource.data.organizerId == 'user123'`.
     * @principle Allows public read access with owner-only writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.organizerId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.organizerId);
    }

    /**
     * @description Allows public read access to community feed posts, but restricts modifications to the author.
     * @path /community_feed/{postId}
     * @allow (read) Any user can read any community feed post.
     * @allow (create) User with ID 'user123' can create a community feed post with `authorId: 'user123'`.
     * @allow (update,delete) User with ID 'user123' can update/delete a community feed post where `resource.data.authorId == 'user123'`.
     * @deny (create) User with ID 'user123' cannot create a community feed post with `authorId: 'user456'`.
     * @deny (update,delete) User with ID 'user456' cannot update/delete a community feed post where `resource.data.authorId == 'user123'`.
     * @principle Allows public read access with owner-only writes.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.authorId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Allows authenticated users to create, update, and delete reports. No ownership enforced.
     * @path /reports/{reportId}
     * @allow (create,update,delete) Any authenticated user can create, update, and delete reports.
     * @principle Requires authentication for writes, but does not enforce ownership.
     */
    match /reports/{reportId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows authenticated users to create, update, and delete transactions. No ownership enforced.
     * @path /transactions/{transactionId}
     * @allow (create,update,delete) Any authenticated user can create, update, and delete transactions.
     * @principle Requires authentication for writes, but does not enforce ownership.
     */
    match /transactions/{transactionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows admins to be created if signed in
     * @path /roles_admin/{userId}
     * @allow (create) Any authenticated user can create a doc
     * @principle Checking for signed in
     */
     match /roles_admin/{userId} {
        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
    }
  }

  /**
   * @description Checks if the user is signed in.
   * @return {boolean} True if the user is signed in, false otherwise.
   * @example isSignedIn() == true if request.auth != null
   */
  function isSignedIn() {
    return request.auth != null;
  }

  /**
   * @description Checks if the user is the owner of the document.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner, false otherwise.
   * @example isOwner('user123') == true if request.auth.uid == 'user123'
   */
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

    /**
   * @description Checks if the user is the owner of the existing document.
   * @param {string} userId The user ID to check against.
   * @return {boolean} True if the user is the owner and the document exists, false otherwise.
   * @example isExistingOwner('user123') == true if request.auth.uid == 'user123' and resource != null
   */
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}