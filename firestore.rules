/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for personal data and employs denormalization techniques to ensure authorization independence.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Access is restricted to the user themselves.
 * - /listings/{listingId}: Stores listings. Owners can create, update, and delete.
 * - /chats/{chatId}: Stores chat metadata. Access is based on membership defined in the document.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat. Access is based on membership in the parent chat.
 * - /reviews/{reviewId}: Stores reviews.
 * - /events/{eventId}: Stores event information.
 * - /community_feed/{postId}: Stores community feed posts.
 * - /reports/{reportId}: Stores reports.
 * - /transactions/{transactionId}: Stores transaction information.
 * - /roles_admin/{userId}: Stores admin roles. Existence of a document grants admin privileges.
 *
 * Key Security Decisions:
 * - User data is private and only accessible to the user themselves (owner-only).
 * - Listing data can be read by anyone but only created, updated, or deleted by the owner.
 * - Chat access is controlled via a `participants` array on the chat document.
 * - Global admin roles are managed via document existence in the `/roles_admin` collection.
 * - Listing is public read, owner write.
 * - All write operations validate document existence to prevent unintended state changes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profiles, restricting access to the owning user.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures listings, allowing public read access but restricting writes to the owner.
     * @path /listings/{listingId}
     */
    match /listings/{listingId} {
      function isOwner() {
        return request.auth.uid == resource.data.sellerId;
      }

      function isCreatingOwner() {
        return request.auth.uid == request.resource.data.sellerId;
      }

      function isExistingOwner() {
          return request.auth.uid == resource.data.sellerId && exists(resource);
      }
      allow get, list: if true;
      allow create: if isCreatingOwner();
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Secures chats, restricting access to participants.
     * @path /chats/{chatId}
     */
    match /chats/{chatId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isParticipant() {
        return isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      }

      function isCreatingParticipant() {
        return isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      }

      allow get: if isParticipant();
      allow list: if isSignedIn();
      allow create: if isCreatingParticipant();
      allow update: if isParticipant();
      allow delete: if isParticipant();
    }

    /**
     * @description Secures messages within a chat, restricting access to participants of the parent chat.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isChatParticipant(chatId) {
            return get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
        }

        allow get: if isSignedIn() && isChatParticipant(chatId);
        allow list: if isSignedIn() && isChatParticipant(chatId);
        allow create: if isSignedIn() && isChatParticipant(chatId);
        allow update: if isSignedIn() && isChatParticipant(chatId);
        allow delete: if isSignedIn() && isChatParticipant(chatId);
    }

    /**
     * @description Secures reviews, allowing anyone to read and list, but only enables authenticated users to perform write operations
     * @path /reviews/{reviewId}
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Secures events, allowing public read access, but only the organizer can modify.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      function isOwner() {
        return request.auth.uid == resource.data.organizerId;
      }

      function isCreatingOwner() {
        return request.auth.uid == request.resource.data.organizerId;
      }

      function isExistingOwner() {
        return request.auth.uid == resource.data.organizerId && exists(resource);
      }

      allow get, list: if true;
      allow create: if isCreatingOwner();
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Secures community feed posts, allowing public read access, but restricting writes to the author.
     * @path /community_feed/{postId}
     */
    match /community_feed/{postId} {
      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      function isCreatingOwner() {
        return request.auth.uid == request.resource.data.authorId;
      }

      function isExistingOwner() {
        return request.auth.uid == resource.data.authorId && exists(resource);
      }

      allow get, list: if true;
      allow create: if isCreatingOwner();
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Secures reports. Only authenticated users can create a report. No read or write access for non-admins.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures transactions. Only authenticated users can create transactions, but access is restricted to the buyer and seller. No read or write access for non-participants.
     * @path /transactions/{transactionId}
     */
    match /transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures admin roles. Only users with a document in this collection are considered admins.
     * @path /roles_admin/{userId}
     */
     match /roles_admin/{userId} {
        function isAdmin(userId) {
          return request.auth.uid == userId;
        }

        function isExistingAdmin(userId) {
            return isAdmin(userId) && exists(resource);
        }

        allow get: if isAdmin(userId);
        allow list: if false; // Assuming you don't want to list admins
        allow create: if isAdmin(userId);
        allow update: if isExistingAdmin(userId);
        allow delete: if isExistingAdmin(userId);
      }
  }
}