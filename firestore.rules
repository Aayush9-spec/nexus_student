/**
 * @fileoverview Firestore Security Rules for Nexus Student Marketplace.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and listings.
 * Transactions, reviews, and chat messages are accessible to involved parties.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /listings/{listingId}: Stores listings. Includes sellerId for authorization.
 * - /transactions/{transactionId}: Stores transaction data.
 * - /reviews/{reviewId}: Stores reviews.
 * - /messages/{messageId}: Stores individual chat messages.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profiles.
 * - Listings can be read by anyone, but only the seller can modify or delete them.
 * - Transactions can be accessed by the buyer and seller involved.
 * - Reviews can be created for any listing but cannot be modified or deleted.
 * - Chat messages can be accessed by the sender and receiver.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to avoid needing to `get()` the user profile for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get, update, delete) User with ID 'user123' can read, update, and delete their own profile.
     * @deny (create, update, delete) User with ID 'user456' cannot create, update, or delete profile 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to listing documents.
     * @path /listings/{listingId}
     * @allow (get, list) Any user can read or list listings.
     * @allow (create) User with ID 'user123' can create a listing with sellerId 'user123'.
     * @allow (update, delete) User with ID 'user123' can update or delete a listing with sellerId 'user123'.
     * @deny (create) User with ID 'user456' cannot create a listing with sellerId 'user123'.
     * @deny (update, delete) User with ID 'user456' cannot update or delete a listing with sellerId 'user123'.
     * @principle Enforces owner-only writes for listings.
     */
    match /listings/{listingId} {
      function isOwner(sellerId) {
        return request.auth.uid == sellerId;
      }

      function isSignedIn() {
        return request.auth != null;
      }
      
      function isExistingOwner(sellerId) {
        return isOwner(sellerId) && resource != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Controls access to transaction documents.
     * @path /transactions/{transactionId}
     * @allow (get) Buyer 'user123' or seller 'user456' can read transaction 'transactionXYZ'.
     * @deny (create, update, delete, list) No one can create, update, delete, or list transactions directly.
     * @principle Restricts transaction management to backend logic (not directly client-modifiable).
     */
    match /transactions/{transactionId} {
       function isBuyerOrSeller(buyerId, sellerId) {
            return request.auth.uid == buyerId || request.auth.uid == sellerId;
        }

        allow get: if isBuyerOrSeller(resource.data.buyerId, resource.data.sellerId);
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }

    /**
     * @description Controls access to review documents.
     * @path /reviews/{reviewId}
     * @allow (create) Any signed-in user can create a review.
     * @allow (get, list) Any user can read/list reviews.
     * @deny (update, delete) No one can update or delete reviews.
     * @principle Allows public read of reviews, prevents modification.
     */
    match /reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to chat message documents.
     * @path /messages/{messageId}
     * @allow (get) Sender or receiver can get message.
     * @allow (create) Any signed-in user can create a chat message.
     * @deny (list, update, delete) No one can list, update, or delete chat messages.
     * @principle Allows public read of chat messages, prevents modification.
     */
    match /messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isSenderOrReceiver(senderId, receiverId) {
            return request.auth.uid == senderId || request.auth.uid == receiverId;
        }

      allow get: if isSenderOrReceiver(resource.data.senderId, resource.data.receiverId);
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}