/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-based access control model with denormalization to ensure Authorization Independence and Clarity of Intent.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only to the user themselves (owner).
 * - /listings/{listingId}: Publicly readable listings, but only the owner (seller) can create, update, or delete them.
 * - /chats/{chatId}: Chats between users, with access controlled by a participants array within the chat document.
 * - /chats/{chatId}/messages/{messageId}: Messages within chats, accessible only to chat participants.
 * - /reviews/{reviewId}: Reviews of sellers, publicly readable.
 * - /events/{eventId}: Publicly readable events, with owner-only write access.
 * - /community_feed/{postId}: Publicly readable community feed posts, with owner-only write access.
 * - /reports/{reportId}: Publicly writable reports of users or content, no owner.
 * - /transactions/{transactionId}: Transactions between users, no owner.
 * - /roles_admin/{userId}: Collection to store admin roles. Only admins can access. Existence over content.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Public read access is granted to collections like `listings`, `reviews`, `events`, and `community_feed` to facilitate discovery.
 * - Default security posture: Strict owner-only access unless explicitly relaxed.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to enable owner checks without additional reads.
 * - Chats include a `participants` array to manage access control directly within the document.
 * - Reports include `reportedUserId` to record which user was reported.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the resource's owner ID.
     * @return {boolean} True if the user is the existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the current user is a participant in the chat.
     * @param {array} participants An array of user IDs participating in the chat.
     * @return {boolean} True if the user is a participant, false otherwise.
     */
    function isChatParticipant(participants) {
      return isSignedIn() && participants.hasAny([request.auth.uid]);
    }

    /**
     * @description Checks if the current user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their own profile.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.uid: 'user_abc'
     * @deny (create) User with UID 'user_abc' cannot create a profile for 'user_xyz'.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.uid: 'user_xyz'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is disallowed.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for listings.
     * @path /listings/{listingId}
     * @allow (get) Any user can get any listing.
     *   - auth.uid: null
     * @allow (list) Any user can list listings.
     *   - auth.uid: null
     * @allow (create) User with UID 'user_abc' can create a listing if they are the seller.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.sellerId: 'user_abc'
     * @deny (update) User with UID 'user_xyz' cannot update a listing they don't own.
     *   - auth.uid: 'user_xyz'
     *   - resource.data.sellerId: 'user_abc'
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.sellerId);
      allow delete: if isExistingOwner(resource.data.sellerId);
    }

    /**
     * @description Rules for chats.
     * @path /chats/{chatId}
     * @allow (get) User with UID 'user_abc' can get chat 'chat_123' if they are a participant.
     *   - auth.uid: 'user_abc'
     *   - resource.data.participants: ['user_abc', 'user_xyz']
     * @deny (create) User with UID 'user_abc' cannot create a chat if they are not a participant.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.participants: ['user_xyz', 'user_def']
     * @principle Enforces participant-based access control.
     */
    match /chats/{chatId} {
      allow get, list: if isSignedIn() && isChatParticipant(resource.data.participants);
      allow create: if isSignedIn() && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && isChatParticipant(resource.data.participants);
      allow delete: if false; // Deletion is not allowed.
    }

    /**
     * @description Rules for messages within chats.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (create) User with UID 'user_abc' can create a message in chat 'chat_123' if they are a participant.
     *   - auth.uid: 'user_abc'
     *   - get(/databases/$(database)/documents/chats/chat_123).data.participants: ['user_abc', 'user_xyz']
     * @deny (get) User with UID 'user_abc' cannot get a message in chat 'chat_123' if they are not a participant.
     *   - auth.uid: 'user_abc'
     *   - get(/databases/$(database)/documents/chats/chat_123).data.participants: ['user_xyz', 'user_def']
     * @principle Enforces participant-based access control, requiring a `get()` call.
     */
    match /chats/{chatId}/messages/{messageId} {
        allow get, list: if isSignedIn() && isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow create: if isSignedIn() && isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.participants) && request.resource.data.chatId == chatId;
        allow update: if false; // Updates are not allowed.
        allow delete: if false; // Deletion is not allowed.
    }

    /**
     * @description Rules for reviews.
     * @path /reviews/{reviewId}
     * @allow (get) Any user can get any review.
     *   - auth.uid: null
     * @allow (list) Any user can list reviews.
     *   - auth.uid: null
     * @allow (create) Any signed in user can create a review.
     * @principle Allows public reads, signed-in writes.
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false; // Updates are not allowed.
      allow delete: if false; // Deletion is not allowed.
    }

    /**
     * @description Rules for events.
     * @path /events/{eventId}
     * @allow (get) Any user can get any event.
     *   - auth.uid: null
     * @allow (list) Any user can list events.
     *   - auth.uid: null
     * @allow (create) User with UID 'user_abc' can create an event if they are the organizer.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.organizerId: 'user_abc'
     * @deny (update) User with UID 'user_xyz' cannot update an event they don't own.
     *   - auth.uid: 'user_xyz'
     *   - resource.data.organizerId: 'user_abc'
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.organizerId);
      allow delete: if isExistingOwner(resource.data.organizerId);
    }

    /**
     * @description Rules for community feed posts.
     * @path /community_feed/{postId}
     * @allow (get) Any user can get any community feed post.
     *   - auth.uid: null
     * @allow (list) Any user can list community feed posts.
     *   - auth.uid: null
     * @allow (create) User with UID 'user_abc' can create a post if they are the author.
     *   - auth.uid: 'user_abc'
     *   - request.resource.data.authorId: 'user_abc'
     * @deny (update) User with UID 'user_xyz' cannot update a post they don't own.
     *   - auth.uid: 'user_xyz'
     *   - resource.data.authorId: 'user_abc'
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Rules for reports.
     * @path /reports/{reportId}
     * @allow (create) Any signed in user can create a report.
     * @principle Allows any signed-in user to create a report.
     */
    match /reports/{reportId} {
      allow get, list: if false; // Listing reports is not allowed.
      allow create: if isSignedIn();
      allow update: if false; // Updates are not allowed.
      allow delete: if false; // Deletion is not allowed.
    }

    /**
     * @description Rules for transactions.
     * @path /transactions/{transactionId}
     */
    match /transactions/{transactionId} {
      allow get, list: if false; // Listing transactions is not allowed.
      allow create: if false; // Creation is disallowed for now. // TODO: Add logic for creating transactions.
      allow update: if false; // Updates are not allowed.
      allow delete: if false; // Deletion is not allowed.
    }

     /**
      * @description Rules for admin roles.
      * @path /roles_admin/{userId}
      * @allow (create) An admin can create another admin.
      *   - auth.uid: 'admin_abc' (must exist in /roles_admin)
      *   - request.resource.data.uid: 'user_xyz'
      * @principle Only admins can grant admin roles. Existence over content.
      */
    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if false; // Updates are not allowed.
      allow delete: if isAdmin();
    }
  }
}