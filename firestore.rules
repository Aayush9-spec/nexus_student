/**
 * @fileoverview Firestore Security Rules for the student marketplace application.
 *
 * Core Philosophy:
 * This ruleset prioritizes strict authorization based on user identity and role.
 * It employs path-based ownership for user-specific data and membership maps for shared resources like chats.
 * Global admin roles are supported via a dedicated collection.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles.
 * - /listings/{listingId}: Stores listings.
 * - /chats/{chatId}: Stores chat metadata, including participants.
 * - /chats/{chatId}/messages/{messageId}: Stores messages within a chat.
 * - /reviews/{reviewId}: Stores reviews for sellers.
 * - /events/{eventId}: Stores event information.
 * - /community_feed/{postId}: Stores community feed posts.
 * - /reports/{reportId}: Stores reports of users or content.
 * - /transactions/{transactionId}: Stores transaction information.
 * - /roles_admin/{userId}: Stores admin roles. Document existence confers admin privileges.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user documents.
 * - Listings can be read by anyone, but only the seller can modify them.
 * - Chats are accessible only to participants.
 * - The `roles_admin` collection grants admin privileges based on document existence.
 * - List operations are generally restricted to owners or members, except where public access is intended.
 *
 * Denormalization for Authorization:
 * - Listings include the `sellerId` to allow rules to validate ownership without additional reads.
 * - Chats include a `participants` array to define authorized users directly within the document.
 *
 * Structural Segregation:
 * - User data and administrative roles are stored in separate collections (`/users` and `/roles_admin`).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their own profile at /users/user123.
     * @allow (get) - User with UID 'user123' can read their own profile at /users/user123.
     * @allow (update) - User with UID 'user123' can update their own profile at /users/user123.
     * @allow (delete) - User with UID 'user123' can delete their own profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (get) - User with UID 'user456' cannot read the profile at /users/user123.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to listings but restricts write access to the seller.
     * @path /listings/{listingId}
     * @allow (get) - Any user can read a listing at /listings/listing123.
     * @allow (list) - Any user can list listings.
     * @allow (create) - User with UID 'user123' can create a listing with sellerId 'user123'.
     * @allow (update) - User with UID 'user123' can update the listing at /listings/listing123 if they are the seller.
     * @allow (delete) - User with UID 'user123' can delete the listing at /listings/listing123 if they are the seller.
     * @deny (create) - User with UID 'user456' cannot create a listing with sellerId 'user123'.
     * @deny (update) - User with UID 'user456' cannot update the listing at /listings/listing123 if they are not the seller.
     * @principle Enforces document ownership for writes.
     */
    match /listings/{listingId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.sellerId == request.auth.uid;
    }

    /**
     * @description Restricts chat access to participants only.
     * @path /chats/{chatId}
     * @allow (get) - User with UID 'user123' can read a chat if they are a participant.
     * @allow (list) - User with UID 'user123' can list chats if they are a participant.
     * @allow (create) - User with UID 'user123' can create a chat if they are a participant.
     * @allow (update) - User with UID 'user123' can update the chat at /chats/chat123 if they are a participant.
     * @allow (delete) - User with UID 'user123' can delete the chat at /chats/chat123 if they are a participant.
     * @deny (get) - User with UID 'user456' cannot read the chat at /chats/chat123 if they are not a participant.
     * @principle Enforces shared access based on the 'participants' array.
     */
    match /chats/{chatId} {
      allow get: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow list: if isSignedIn(); //TODO: Add list constraints to only chats the user is a participant in.
      allow create: if isSignedIn() && request.resource.data.participants.hasAll([request.auth.uid]);
      allow update: if isSignedIn() && resource.data.participants.hasAny([request.auth.uid]);
      allow delete: if false; // Deleting a chat is not allowed.
    }

    /**
     * @description Restricts message access to participants of the parent chat.
     * @path /chats/{chatId}/messages/{messageId}
     * @allow (get) - User with UID 'user123' can read a message in a chat if they are a participant.
     * @allow (list) - User with UID 'user123' can list messages in a chat if they are a participant.
     * @allow (create) - User with UID 'user123' can create a message in a chat if they are a participant.
     * @allow (update) - No one can update a message once it is created.
     * @allow (delete) - No one can delete a message.
     * @deny (get) - User with UID 'user456' cannot read a message in the chat if they are not a participant.
     * @principle Enforces shared access based on the parent chat's 'participants' array.
     */
    match /chats/{chatId}/messages/{messageId} {
        allow get: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
        allow list: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]);
        allow create: if isSignedIn() && get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]) && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if false;
    }

    /**
     * @description Allows anyone to read reviews, but restricts creation, updates, and deletion.
     * @path /reviews/{reviewId}
     * @allow (get) - Any user can read a review at /reviews/review123.
     * @allow (list) - Any user can list reviews.
     * @allow (create) - Any signed in user can create a review.
     * @allow (update) - No one can update a review.
     * @allow (delete) - No one can delete a review.
     */
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows anyone to read events, but restricts creation, updates, and deletion to the organizer.
     * @path /events/{eventId}
     * @allow (get) - Any user can read an event at /events/event123.
     * @allow (list) - Any user can list events.
     * @allow (create) - User with UID 'user123' can create an event with organizerId 'user123'.
     * @allow (update) - User with UID 'user123' can update the event at /events/event123 if they are the organizer.
     * @allow (delete) - User with UID 'user123' can delete the event at /events/event123 if they are the organizer.
     * @deny (create) - User with UID 'user456' cannot create an event with organizerId 'user123'.
     * @deny (update) - User with UID 'user456' cannot update the event at /events/event123 if they are not the organizer.
     * @principle Enforces document ownership for writes.
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.organizerId == request.auth.uid;
    }

    /**
     * @description Allows public read access to community feed posts, but restricts writes to the author.
     * @path /community_feed/{postId}
     * @allow (get) - Any user can read a community feed post at /community_feed/post123.
     * @allow (list) - Any user can list community feed posts.
     * @allow (create) - User with UID 'user123' can create a community feed post with authorId 'user123'.
     * @allow (update) - User with UID 'user123' can update the community feed post at /community_feed/post123 if they are the author.
     * @allow (delete) - User with UID 'user123' can delete the community feed post at /community_feed/post123 if they are the author.
     * @deny (create) - User with UID 'user456' cannot create a community feed post with authorId 'user123'.
     * @deny (update) - User with UID 'user456' cannot update the community feed post at /community_feed/post123 if they are not the author.
     * @principle Enforces document ownership for writes.
     */
    match /community_feed/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow delete: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
    }

    /**
     * @description Allows anyone to create reports, but no one can read, update or delete them.
     * @path /reports/{reportId}
     * @allow (create) - Any signed in user can create a report.
     * @allow (get) - No one can get a report.
     * @allow (list) - No one can list reports.
     * @allow (update) - No one can update a report.
     * @allow (delete) - No one can delete a report.
     */
    match /reports/{reportId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows anyone to read transactions, but restricts creation, updates, and deletion.
     * @path /transactions/{transactionId}
     *  @allow (get) - Anyone can read a transaction
     *  @allow (list) - Anyone can list transactions.
     *  @allow (create) - Only authenticated users can create a transaction.
     *  @allow (update) - No one can update a transaction.
     *  @allow (delete) - No one can delete a transaction.
     */
    match /transactions/{transactionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Grants admin privileges based on document existence in this collection.
     * @path /roles_admin/{userId}
     * @allow (get) - User with UID 'admin123' can read their admin role at /roles_admin/admin123.
     * @allow (list) - No one can list roles
     * @allow (create) - User with UID 'admin123' can create their admin role at /roles_admin/admin123.
     * @allow (update) - No one can update a admin role.
     * @allow (delete) - User with UID 'admin123' can delete their admin role at /roles_admin/admin123.
     * @deny (create) - User with UID 'user456' cannot create an admin role at /roles_admin/admin123.
     * @principle Checks for document existence to grant admin privileges.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin(userId) {
      return exists(/databases/$(database)/documents/roles_admin/$(userId));
  }
}